<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة المخزون والفواتير</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c3e50;
            --primary-dark: #1a252f;
            --secondary: #3498db;
            --secondary-light: #5dade2;
            --success: #27ae60;
            --success-light: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #95a5a6;
            --light-gray: #bdc3c7;
            --border: #dfe6e9;
            --card-bg: #ffffff;
            --body-bg: #f8f9fa;
            --sidebar-bg: #2c3e50;
            --sidebar-hover: #34495e;
            --text-dark: #2d3436;
            --text-light: #636e72;
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Tajawal', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--body-bg);
            color: var(--text-dark);
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 260px;
            background: linear-gradient(180deg, var(--primary), var(--primary-dark));
            color: white;
            transition: var(--transition);
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }
        
        .sidebar-menu {
            padding: 20px 0;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            cursor: pointer;
            transition: var(--transition);
            border-left: 4px solid transparent;
        }
        
        .menu-item:hover, .menu-item.active {
            background: var(--sidebar-hover);
            border-left: 4px solid var(--secondary-light);
        }
        
        .menu-item i {
            width: 30px;
            font-size: 1.1rem;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .menu-item span {
            font-size: 1rem;
            font-weight: 500;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            width: 100%;
            max-width: 100%;
            overflow: hidden;
        }
        
        .topbar {
            background: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            z-index: 100;
        }
        
        .search-container {
            position: relative;
            width: 350px;
        }
        
        .search-container input {
            width: 100%;
            padding: 10px 15px 10px 40px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--body-bg);
            transition: var(--transition);
        }
        
        .search-container input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .search-container i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--gray);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--secondary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }
        
        .notification-icon {
            position: relative;
            font-size: 1.2rem;
            color: var(--text-light);
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--danger);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Content Area */
        .content-area {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            max-width: 100%;
            width: 100%;
            box-sizing: border-box;
            margin: 0;
            min-width: 0;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }
        
        .content-header h2 {
            font-size: 1.8rem;
            color: var(--primary);
            font-weight: 700;
        }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            overflow: hidden;
        }
        
        .card-header {
            padding: 20px 25px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .card-header h3 {
            font-size: 1.4rem;
            color: var(--primary);
            font-weight: 600;
        }
        
        .card-body {
            padding: 0;
            overflow-x: auto;
        }
        
        /* Tables */
        .table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        
        .table th {
            background: var(--light);
            color: var(--primary);
            font-weight: 600;
            text-align: right;
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .table td {
            padding: 15px 20px;
            border-bottom: 1px solid var(--border);
            color: var(--text-dark);
        }
        
        .table tr:last-child td {
            border-bottom: none;
        }
        
        .table tr:hover {
            background: rgba(52, 152, 219, 0.03);
        }
        
        /* Buttons */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary), var(--secondary-light));
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(52, 152, 219, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success), var(--success-light));
            color: white;
            box-shadow: 0 4px 12px rgba(46, 204, 113, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger), #fc5c65);
            color: white;
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.3);
        }
        
        .btn-warning {
            background: linear-gradient(135deg, var(--warning), #fed330);
            color: white;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.3);
        }
        
        .btn-outline {
            background: transparent;
            border: 2px solid var(--secondary);
            color: var(--secondary);
        }
        
        .btn-sm {
            padding: 8px 15px;
            font-size: 0.9rem;
        }
        
        .btn-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            margin: 0 2px;
        }
        
        .btn-edit {
            background-color: #e3f2fd;
            color: #1976d2;
        }
        
        .btn-edit:hover {
            background-color: #bbdefb;
        }
        
        .btn-delete {
            background-color: #ffebee;
            color: #d32f2f;
        }
        
        .btn-delete:hover {
            background-color: #ffcdd2;
        }
        
        .action-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-light);
            cursor: pointer;
            transition: var(--transition);
            margin: 0 2px;
            font-size: 14px;
        }
        
        .action-btn:hover {
            background: rgba(52, 152, 219, 0.1);
            color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .action-btn.edit {
            color: var(--success);
            border-color: rgba(46, 204, 113, 0.3);
        }
        
        .action-btn.edit:hover {
            background: rgba(46, 204, 113, 0.1);
            color: var(--success);
            border-color: var(--success);
        }
        
        .action-btn.delete {
            color: var(--danger);
            border-color: rgba(231, 76, 60, 0.3);
        }
        
        /* Customer History Modal Styles */
        .invoices-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .invoice-card {
            background: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            overflow: visible; /* Changed from hidden to prevent cutting off content */
            border: 1px solid #e0e0e0;
        }
        
        .invoice-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .invoice-date {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #555;
            font-weight: 500;
        }
        
        .invoice-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .invoice-items {
            padding: 12px 16px;
        }
        
        .invoice-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #eee;
        }
        
        .invoice-item:last-child {
            border-bottom: none;
        }
        
        .invoice-footer {
            padding: 12px 16px;
            background-color: #f8f9fa;
            border-top: 1px solid #e0e0e0;
            text-align: left;
            font-weight: 600;
        }
        
        .invoice-total {
            color: var(--primary);
        }
        
        .action-btn.delete:hover {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
            border-color: var(--danger);
        }
        
        /* Icons */
        /* Base icon styles */
        i.fas, i.far, i.fab, i.fa {
            font-size: 1em;
            line-height: 1;
            vertical-align: middle;
            transition: var(--transition);
        }
        
        /* Icons in buttons */
        .btn i {
            margin-left: 6px;
            font-size: 0.95em;
        }
        
        /* Icons in action buttons */
        .action-btn i {
            font-size: 1.1em;
            transition: inherit;
        }
        
        /* Icons in sidebar menu */
        .menu-item i {
            width: 24px;
            text-align: center;
            margin-left: 8px;
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .menu-item:hover i, 
        .menu-item.active i {
            opacity: 1;
            color: var(--secondary-light);
        }
        
        /* Icons in cards and summaries */
        .summary-icon i {
            font-size: 1.8em;
            opacity: 0.9;
        }
        
        /* Modal close icons */
        .close-btn i {
            font-size: 1.2rem;
            transition: var(--transition);
        }
        
        .close-btn:hover i {
            transform: rotate(90deg);
        }
        
        /* Status Badges */
        .status-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            display: inline-block;
        }
        
        .status-success { background: #eafaf1; color: var(--success); }
        .status-warning { background: #fef9e7; color: var(--warning); }
        .status-danger { background: #fceae8; color: var(--danger); }
        .status-available { background-color: #d4edda; color: #155724; }
        .status-unavailable { background-color: #f8d7da; color: #721c24; }
        
        /* Dashboard Summary */
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }
        
        .summary-card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s ease;
        }
        
        .summary-card:hover {
            transform: translateY(-5px);
        }
        
        .summary-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }
        
        .card-1 .summary-icon { background: rgba(52, 152, 219, 0.1); color: var(--secondary); }
        .card-2 .summary-icon { background: rgba(46, 204, 113, 0.1); color: var(--success); }
        .card-3 .summary-icon { background: rgba(231, 76, 60, 0.1); color: var(--danger); }
        .card-4 .summary-icon { background: rgba(243, 156, 18, 0.1); color: var(--warning); }
        
        .summary-info h3 {
            font-size: 1.1rem;
            color: var(--text-light);
            margin-bottom: 5px;
        }
        
        .summary-info .value {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--primary);
        }
        
        .summary-info .sub-value {
            font-size: 1rem;
            color: var(--success);
            margin-top: 5px;
        }
        
        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 25px 0;
            gap: 8px;
            flex-wrap: wrap;
            padding: 15px 0;
            direction: rtl;
            width: 100%;
        }
        
        .pagination button, .pagination .pagination-btn {
            padding: 8px 12px;
            border: 1px solid #e0e0e0;
            background: #fff;
            color: #333;
            border-radius: 6px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            min-width: 36px;
            height: 36px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
            line-height: 1;
            margin: 2px;
        }
        
        .pagination .pagination-ellipsis {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            min-width: 24px;
            height: 36px;
            color: #666;
            user-select: none;
            padding: 0 8px;
        }
        
        .pagination button:hover:not(.active):not(:disabled),
        .pagination .pagination-btn:hover:not(.active):not(:disabled) {
            background-color: #f5f5f5;
            border-color: #d0d0d0;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .pagination button.active, .pagination .pagination-btn.active {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
            font-weight: 600;
        }
        
        .pagination button:disabled,
        .pagination .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Filter Section */
        .filter-section {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .filter-group label {
            font-weight: 500;
            color: var(--text-dark);
        }
        
        .filter-select {
            padding: 10px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            font-size: 1rem;
        }
        
        /* Alert Messages */
        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .alert-success {
            background: #eafaf1;
            color: var(--success);
            border: 1px solid var(--success);
        }
        
        .alert-danger {
            background: #fceae8;
            color: var(--danger);
            border: 1px solid var(--danger);
        }
        
        .close-alert {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: inherit;
            cursor: pointer;
        }
        
        /* Invoice Items */
        .invoice-item {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            align-items: flex-end;
        }
        
        .invoice-item > div {
            flex: 1;
        }
        
        .invoice-items-container {
            margin: 20px 0;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 15px;
        }
        
        .invoice-summary {
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
        }
        
        .summary-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
        }
        
        .summary-total {
            font-weight: bold;
            font-size: 1.2rem;
            border-top: 2px solid var(--border);
            margin-top: 10px;
            padding-top: 10px;
        }
        
        /* Stock Indicators */
        .low-stock { color: var(--danger); font-weight: bold; }
        .no-stock { color: var(--gray); text-decoration: line-through; }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
        }
        
        .empty-state i {
            font-size: 48px;
            color: #e0e0e0;
            margin-bottom: 15px;
        }
        
        .empty-state h3 {
            color: #6c757d;
            margin-bottom: 10px;
        }
        
        .empty-state p {
            color: #adb5bd;
            margin: 0;
        }
        
        /* Form Controls */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-dark);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .form-row .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        /* Modals */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            overflow-y: auto;
            padding: 20px 0;
        }
        
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
            backdrop-filter: blur(4px);
        }
        
        .modal {
            background: white;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            animation: modalFadeIn 0.3s ease;
            margin: 0 auto;
            max-height: 100%;
        }
        
        .modal-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
            -webkit-overflow-scrolling: touch;
            max-height: calc(90vh - 130px); /* Adjust based on header/footer height */
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .modal-header .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            font-size: 1.2rem;
            cursor: pointer;
            color: var(--text-light);
        }
        
        .modal-header .close-btn:hover {
            background: var(--light);
        }
        
        .modal-body {
            padding: 25px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        /* Confirmation Dialog */
        .confirmation-dialog {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            text-align: center;
        }
        
        .confirmation-dialog h3 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .confirmation-dialog p {
            margin-bottom: 25px;
            color: var(--text-light);
            line-height: 1.6;
        }
        
        .confirmation-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
        }
        
        /* Responsive Design */
        @media (max-width: 1200px) {
            .sidebar {
                width: 80px;
                overflow: visible;
            }
            
            .menu-item {
                justify-content: center;
                padding: 15px;
                position: relative;
            }
            
            .menu-item i {
                width: auto;
                font-size: 1.3rem;
            }
        }
        
        @media (max-width: 992px) {
            .content-area {
                padding: 20px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .search-container {
                width: 250px;
            }
            
            .content-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 15px;
            }
            
            .invoice-item {
                flex-direction: column;
                align-items: stretch;
            }
        }
        
        /* Search Box Hover & Focus Styles */
        .search-input:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2) !important;
            background-color: #fff !important;
        }
        
        .search-input:hover {
            border-color: #9ca3af;
            background-color: #fff !important;
        }
        
        @media (max-width: 768px) {
            .content-area {
                padding: 15px;
            }
            
            .summary-cards {
                grid-template-columns: 1fr;
            }
            
            .search-container {
                width: 200px;
            }
            
            .topbar {
                padding: 10px 15px;
            }
            
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
                overflow-x: auto;
                scrollbar-width: none;
            }
            
            .sidebar::-webkit-scrollbar {
                display: none;
            }
            
            .sidebar-menu {
                display: flex;
                width: max-content;
                min-width: 100%;
                padding: 0;
                margin: 0;
            }
            
            .menu-item {
                padding: 15px 20px;
                white-space: nowrap;
                border: none;
                border-bottom: 3px solid transparent;
                flex-shrink: 0;
                display: flex !important;
                align-items: center;
                justify-content: center;
            }
            
            .menu-item:hover, .menu-item.active {
                background: var(--sidebar-hover);
                border-bottom-color: var(--secondary-light);
            }
            
            .menu-item i {
                margin: 0 5px;
                font-size: 1.4rem;
                min-width: 24px;
                text-align: center;
            }
            
            .table th, .table td {
                padding: 8px 5px;
                font-size: 0.9rem;
                min-width: 100px;
            }
            
            .table td:first-child,
            .table th:first-child {
                padding-right: 15px;
            }
            
            .table td:last-child,
            .table th:last-child {
                padding-left: 15px;
            }
        }
        
        /* Animation */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-menu">
                <div class="menu-item active" data-page="dashboard-page">
                    <i class="fas fa-home"></i>
                    <span>الرئيسية</span>
                </div>
                <div class="menu-item" data-page="products-page">
                    <i class="fas fa-box-open"></i>
                    <span>إدارة المنتجات</span>
                </div>
                <div class="menu-item" data-page="invoices-page">
                    <i class="fas fa-file-invoice-dollar"></i>
                    <span>الفواتير</span>
                </div>
                <div class="menu-item" data-page="customers-page">
                    <i class="fas fa-users"></i>
                    <span>العملاء</span>
                </div>
                <div class="menu-item" data-page="suppliers-page">
                    <i class="fas fa-truck"></i>
                    <span>الموردين</span>
                </div>
            </div>
        </div>
        
        <!-- Main Content -->
        <div class="main-content">
            <div class="content-area">
                <!-- Dashboard Page -->
                <div id="dashboard-page">
                    <div class="content-header">
                        <h2>لوحة التحكم</h2>
                        <div>
                            <button class="btn btn-primary" id="add-invoice-btn">
                                <i class="fas fa-plus"></i> إضافة فاتورة جديدة
                            </button>
                        </div>
                    </div>
                    
                    <!-- Summary Cards -->
                    <div class="summary-cards">
                        <div class="summary-card card-1 fade-in">
                            <div class="summary-icon">
                                <i class="fas fa-boxes"></i>
                            </div>
                            <div class="summary-info">
                                <h3>إجمالي المنتجات</h3>
                                <div class="value" id="total-products">0</div>
                                <div class="sub-value" id="products-change">+0 هذا الشهر</div>
                            </div>
                        </div>
                        
                        <div class="summary-card card-2 fade-in">
                            <div class="summary-icon">
                                <i class="fas fa-file-invoice-dollar"></i>
                            </div>
                            <div class="summary-info">
                                <h3>الفواتير هذا الشهر</h3>
                                <div class="value" id="monthly-invoices">0</div>
                                <div class="sub-value" id="invoices-change">+0 عن الشهر الماضي</div>
                            </div>
                        </div>
                        
                        <div class="summary-card card-3 fade-in">
                            <div class="summary-icon">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="summary-info">
                                <h3>منتجات منخفضة</h3>
                                <div class="value" id="low-stock-count">0</div>
                                <div class="sub-value">تحتاج للتزويد</div>
                            </div>
                        </div>
                        
                        <div class="summary-card card-4 fade-in">
                            <div class="summary-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="summary-info">
                                <h3>قيمة المخزون</h3>
                                <div class="value" id="inventory-value">0 ج.م</div>
                                <div class="sub-value" id="inventory-change">+0% عن الشهر الماضي</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Latest Products -->
                    <div class="card fade-in">
                        <div class="card-header">
                            <h3>أحدث المنتجات</h3>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>السعر (ج.م)</th>
                                        <th>الكمية</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="latest-products-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Recent Invoices -->
                    <div class="card fade-in">
                        <div class="card-header">
                            <h3>آخر الفواتير</h3>
                        </div>
                        <div class="card-body">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>العميل</th>
                                        <th>التاريخ</th>
                                        <th>المبلغ</th>
                                        <th>الحالة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="recent-invoices-table-body">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Products Management Page -->
                <div id="products-page" style="display: none;">
                    <div class="content-header">
                        <h2>إدارة المنتجات</h2>
                        <div>
                            <button class="btn btn-primary" id="add-product-btn">
                                <i class="fas fa-plus"></i> إضافة منتج جديد
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="search-container" style="width: 300px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="product-search" placeholder="ابحث عن منتج...">
                        </div>
                        
                        <div class="filter-group">
                            <label for="status-filter">حالة المخزون:</label>
                            <select id="status-filter" class="filter-select">
                                <option value="all">جميع الحالات</option>
                                <option value="available">متوفر</option>
                                <option value="low">كمية منخفضة</option>
                                <option value="out">منتهي</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="products-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>اسم المنتج</th>
                                            <th>السعر</th>
                                            <th>الكمية</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="products-table-body">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" id="products-pagination">
                                <!-- Pagination will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Invoices Management Page -->
                <div id="invoices-page" style="display: none;">
                    <div class="content-header">
                        <h2>إدارة الفواتير</h2>
                        <div>
                            <button class="btn btn-primary" id="add-invoice-btn">
                                <i class="fas fa-plus"></i> إضافة فاتورة جديدة
                            </button>
                        </div>
                    </div>
                    
                    <div class="filter-section">
                        <div class="search-container" style="width: 300px;">
                            <i class="fas fa-search"></i>
                            <input type="text" id="invoice-search" placeholder="ابحث عن فاتورة...">
                        </div>
                        
                        <div class="filter-group">
                            <label for="status-invoice-filter">حالة الفاتورة:</label>
                            <select id="status-invoice-filter" class="filter-select">
                                <option value="all">جميع الحالات</option>
                                <option value="paid">مدفوعة</option>
                                <option value="unpaid">غير مدفوعة</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table" id="invoices-table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>العميل</th>
                                            <th>التاريخ</th>
                                            <th>المبلغ</th>
                                            <th>الحالة</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="invoices-table-body">
                                        <!-- Will be populated by JavaScript -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" id="invoices-pagination">
                                <!-- Pagination will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Page -->
                <div id="reports-page" style="display: none;">
                    <div class="content-header">
                        <h2>التقارير</h2>
                        <div>
                            <button class="btn btn-outline">
                                <i class="fas fa-file-export"></i> تصدير
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="empty-state">
                                <i class="fas fa-chart-bar"></i>
                                <h3>لوحة التقارير</h3>
                                <p>سيتم إضافة التقارير والتحليلات هنا قريباً</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Customers Page -->
                <div id="customers-page" style="display: none;">
                    <div class="content-header">
                        <h2>إدارة العملاء</h2>
                        <div>
                            <button class="btn btn-primary" id="add-customer-btn">
                                <i class="fas fa-plus"></i> إضافة عميل جديد
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>الاسم</th>
                                            <th>رقم الهاتف</th>
                                            <th>الرصيد</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="customers-table-body">
                                        <!-- Customers will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" id="customers-pagination">
                                <!-- Pagination will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Suppliers Page -->
                <div id="suppliers-page" style="display: none;">
                    <div class="content-header" style="align-items: center;">
                        <h2 style="margin: 0;">إدارة الموردين</h2>
                        <div style="display: flex; gap: 15px; align-items: center;">
                            <div class="search-box" style="position: relative; margin: 0;">
                                <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: #6c757d;"></i>
                                <input type="text" id="supplier-search" class="search-input" placeholder="ابحث عن مورد..." 
                                    style="padding: 10px 40px 10px 15px; border: 1px solid #e0e0e0; border-radius: 8px; 
                                    width: 300px; font-size: 14px; transition: all 0.3s ease;
                                    background-color: #f8f9fa; outline: none;
                                    box-shadow: 0 1px 3px rgba(0,0,0,0.05);
                                    height: 42px;
                                    border-color: #d1d5db;">
                            </div>
                            <button class="btn btn-primary" id="add-supplier-btn" 
                                style="white-space: nowrap; padding: 10px 20px; font-weight: 500;">
                                <i class="fas fa-plus"></i> إضافة مورد جديد
                            </button>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>#</th>
                                            <th>اسم المورد</th>
                                            <th>رقم الهاتف</th>
                                            <th>الإجراءات</th>
                                        </tr>
                                    </thead>
                                    <tbody id="suppliers-table-body">
                                        <!-- Suppliers will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                            <div class="pagination" id="suppliers-pagination">
                                <!-- Pagination will be added here by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Reports Page Removed -->
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="product-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="product-modal-title">إضافة منتج جديد</h3>
                <button class="close-btn" id="close-product-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="product-form">
                    <input type="hidden" id="product-id">
                    <div class="form-group">
                        <label for="product-name">اسم المنتج *</label>
                        <input type="text" id="product-name" class="form-control" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="product-balance">السعر (ج.م) *</label>
                            <input type="number" id="product-balance" class="form-control" min="0" step="0.01" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="product-quantity">الكمية *</label>
                            <input type="number" id="product-quantity" class="form-control" min="0" required>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="product-supplier">المورد</label>
                        <select id="product-supplier" class="form-control">
                            <option value="">-- اختر المورد --</option>
                            <!-- Suppliers will be populated by JavaScript -->
                        </select>
                    </div>
                    
                    <!-- Purchase History Section Removed -->
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-product-modal">إلغاء</button>
                <button type="button" class="btn btn-success" id="save-product">حفظ المنتج</button>
            </div>
        </div>
    </div>
    
    <!-- Customer Modal -->
    <div class="modal-overlay" id="customer-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="customer-modal-title">إضافة عميل جديد</h3>
                <button class="close-btn" id="close-customer-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="customer-form">
                    <input type="hidden" id="customer-id">
                    <div class="form-group">
                        <label for="customer-name">اسم العميل *</label>
                        </div>
                    </div>
                    

                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-customer-modal">إلغاء</button>
                <button type="button" class="btn btn-success" id="save-customer">حفظ العميل</button>
            </div>
        </div>
    </div>
    
    <!-- Supplier Modal -->
    <div class="modal-overlay" id="supplier-modal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="supplier-modal-title">إضافة مورد جديد</h3>
                <button class="close-btn" id="close-supplier-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="supplier-form">
                    <input type="hidden" id="supplier-id">
                    <div class="form-group">
                        <label for="supplier-name">اسم المورد *</label>
                        <input type="text" id="supplier-name" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="supplier-phone">رقم الهاتف *</label>
                        <input type="tel" id="supplier-phone" class="form-control" required>
                    </div>
                    
                    <!-- Supplier Items History -->
                    <div class="form-group" id="supplier-items-container" style="display: none; margin-top: 20px;">
                        <label>سجل المشتريات من المورد</label>
                        <div class="table-responsive">
                            <table class="data-table" style="width: 100%;">
                                <thead>
                                    <tr>
                                        <th>اسم المنتج</th>
                                        <th>التاريخ</th>
                                        <th>الكمية</th>
                                        <th>السعر</th>
                                        <th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody id="supplier-items-body">
                                    <!-- Items will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-supplier-modal">إلغاء</button>
                <button type="button" class="btn btn-success" id="save-supplier">حفظ المورد</button>
            </div>
        </div>
    </div>

    <!-- Invoice Modal -->
    <div class="modal-overlay" id="invoice-modal">
        <div class="modal" style="max-width: 800px;">
            <div class="modal-header">
                <h3 id="invoice-modal-title">فاتورة جديدة</h3>
                <button class="close-btn" id="close-invoice-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="invoice-form">
                    <input type="hidden" id="invoice-id">
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label for="invoice-customer">العميل *</label>
                            <select id="invoice-customer" class="form-control" required>
                                <option value="">اختر عميلاً</option>
                                <!-- Clients will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="invoice-status">حالة الدفع</label>
                            <select id="invoice-status" class="form-control" required>
                                <option value="sales">فاتورة مبيعات</option>
                                <option value="paid">مدفوعة</option>
                                <option value="unpaid" selected>غير مدفوعة</option>
                                <option value="partial">مدفوعة جزئياً</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="invoice-date">تاريخ الفاتورة *</label>
                            <input type="date" id="invoice-date" class="form-control" required>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="m-0">بنود الفاتورة</h4>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="add-invoice-item">
                                <i class="fas fa-plus ml-1"></i>
                                <span>إضافة بند</span>
                            </button>
                        </div>
                        <div style="width: 100%;">
                            <div style="overflow: hidden; border-radius: 8px 8px 0 0; background-color: #f8f9fa;">
                                <table style="width: 100%; border-collapse: collapse;">
                                    <thead>
                                        <tr>
                                            <th style="padding: 12px 15px; text-align: right; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #dee2e6;">المنتج</th>
                                            <th style="padding: 12px 15px; text-align: center; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #dee2e6; width: 200px;">الكمية</th>
                                            <th style="padding: 12px 15px; text-align: left; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #dee2e6; width: 150px;">الإجمالي</th>
                                            <th style="padding: 12px 15px; text-align: center; font-weight: 600; color: #2c3e50; border-bottom: 2px solid #dee2e6; width: 70px;">حذف</th>
                                        </tr>
                                    </thead>
                                </table>
                            </div>
                            <div style="max-height: 400px; overflow-y: auto; border: 1px solid #e0e0e0; border-top: none; border-radius: 0 0 8px 8px;">
                                <table class="table" id="invoice-items-table" style="width: 100%; border-collapse: collapse;">
                                    <tbody id="invoice-items-body" style="width: 100%;">
                                        <!-- Invoice items will be added here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice Summary -->
                    <div class="invoice-summary">
                        <div class="summary-row summary-total">
                            <span>الإجمالي:</span>
                            <span id="invoice-total">0.00 ج.م</span>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline" id="cancel-invoice-modal">إلغاء</button>
                <button type="button" class="btn btn-primary" id="print-invoice" style="margin-left: 10px;">
                    <i class="fas fa-print"></i> طباعة الفاتورة
                </button>
                <button type="button" class="btn btn-success" id="save-invoice">حفظ الفاتورة</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>تأكيد الحذف</h3>
                <button class="close-btn" id="close-delete-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="delete-message">هل أنت متأكد أنك تريد حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-delete-modal">إلغاء</button>
                <button class="btn btn-danger" id="confirm-delete">حذف</button>
            </div>
        </div>
    </div>

    </style>
    
    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="delete-modal">
        <div class="modal">
            <div class="modal-header">
                <h3>تأكيد الحذف</h3>
                <button class="close-btn" id="close-delete-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p id="delete-message">هل أنت متأكد أنك تريد حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-outline" id="cancel-delete-modal">إلغاء</button>
                <button class="btn btn-danger" id="confirm-delete">حذف</button>
            </div>
        </div>
    </div>

    <!-- Add Chart.js library -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="assets.js"></script>
    <script>
        // Main Application Class
        class InventorySystem {
            constructor() {
                this.products = [];
                this.invoices = [];
                this.customers = [];
                this.suppliers = [];
                this.currentPage = {
                    products: 1,
                    invoices: 1,
                    customers: 1,
                    suppliers: 1
                };
                this.itemsPerPage = 10;
                this.currentDeleteId = null;
                this.currentDeleteType = null;
                this.filteredProducts = []; // Store filtered products for pagination
                
                // Initialize search inputs and filter selects
                this.searchInputs = {
                    products: null,
                    invoices: null,
                    customers: null,
                    suppliers: null
                };
                
                this.filterSelects = {
                    products: null,
                    invoices: null,
                    status: null
                };
                
                this.initElements();
                this.loadData();
                this.setupEventListeners();
                this.showPage('dashboard-page');
                this.updateDashboard();
            }
            
            initElements() {
                // Pages
                this.pages = {
                    dashboard: document.getElementById('dashboard-page'),
                    products: document.getElementById('products-page'),
                    invoices: document.getElementById('invoices-page'),
                    reports: document.getElementById('reports-page'),
                    customers: document.getElementById('customers-page'),
                    suppliers: document.getElementById('suppliers-page')
                };
                
                // Menu items
                this.menuItems = document.querySelectorAll('.menu-item');
                
                // Tables
                this.tables = {
                    latestProducts: document.getElementById('latest-products-table-body'),
                    recentInvoices: document.getElementById('recent-invoices-table-body'),
                    products: document.getElementById('products-table-body'),
                    invoices: document.getElementById('invoices-table-body'),
                    customers: document.getElementById('customers-table-body'),
                    suppliers: document.getElementById('suppliers-table-body'),
                    invoiceItems: document.getElementById('invoice-items-body')
                };
                
                // Pagination
                this.pagination = {
                    products: document.getElementById('products-pagination'),
                    invoices: document.getElementById('invoices-pagination'),
                    customers: document.getElementById('customers-pagination'),
                    suppliers: document.getElementById('suppliers-pagination')
                };
                
                // Search and filter inputs
                this.searchInputs.products = document.getElementById('product-search');
                this.searchInputs.invoices = document.getElementById('invoice-search');
                this.searchInputs.suppliers = document.getElementById('supplier-search');
                
                this.filterSelects.products = document.getElementById('status-filter');
                this.filterSelects.invoices = document.getElementById('status-invoice-filter');
                
                // Buttons
                this.buttons = {
                    addProduct: document.getElementById('add-product-btn'),
                    // We'll handle the addInvoice buttons separately in the event listeners
                    addCustomer: document.getElementById('add-customer-btn'),
                    addSupplier: document.getElementById('add-supplier-btn'),
                    addInvoiceItem: document.getElementById('add-invoice-item'),
                    saveProduct: document.getElementById('save-product'),
                    saveInvoice: document.getElementById('save-invoice'),
                    printInvoice: document.getElementById('print-invoice'),
                    saveCustomer: document.getElementById('save-customer'),
                    saveSupplier: document.getElementById('save-supplier'),
                    cancelDelete: document.getElementById('cancel-delete-modal'),
                    confirmDelete: document.getElementById('confirm-delete'),
                    cancelCustomer: document.getElementById('cancel-customer-modal'),
                    cancelSupplier: document.getElementById('cancel-supplier-modal')
                };
                
                // Modals
                this.modals = {
                    product: document.getElementById('product-modal'),
                    customer: document.getElementById('customer-modal'),
                    supplier: document.getElementById('supplier-modal'),
                    invoice: document.getElementById('invoice-modal'),
                    delete: document.getElementById('delete-modal')
                };
                
                // Modal close buttons
                this.modalCloseButtons = {
                    product: document.getElementById('close-product-modal'),
                    customer: document.getElementById('close-customer-modal'),
                    delete: document.getElementById('close-delete-modal'),
                    invoice: document.getElementById('close-invoice-modal'),
                    delete: document.getElementById('close-delete-modal'),
                    cancelProduct: document.getElementById('cancel-product-modal'),
                    cancelCustomer: document.getElementById('cancel-customer-modal'),
                    cancelInvoice: document.getElementById('cancel-invoice-modal')
                };
                
                // Forms
                this.forms = {
                    product: document.getElementById('product-form'),
                    customer: document.getElementById('customer-form'),
                    invoice: document.getElementById('invoice-form')
                };
                
                // Form fields
                this.formFields = {
                    product: {
                        id: document.getElementById('product-id'),
                        name: document.getElementById('product-name'),
                        balance: document.getElementById('product-balance'),
                        quantity: document.getElementById('product-quantity'),
                        description: document.getElementById('product-description')
                    },
                    customer: {
                        id: document.getElementById('customer-id'),
                        name: document.getElementById('customer-name'),
                        phone: document.getElementById('customer-phone'),
                        balance: document.getElementById('customer-balance'),
                        address: document.getElementById('customer-address'),
                        date: document.getElementById('customer-date')
                    },
                    supplier: {
                        id: document.getElementById('supplier-id'),
                        name: document.getElementById('supplier-name'),
                        phone: document.getElementById('supplier-phone')
                    },
                    invoice: {
                        id: document.getElementById('invoice-id'),
                        customer: document.getElementById('invoice-customer'),
                        date: document.getElementById('invoice-date')
                    }
                };
                
                // Dashboard elements
                this.dashboardElements = {
                    totalProducts: document.getElementById('total-products'),
                    productsChange: document.getElementById('products-change'),
                    monthlyInvoices: document.getElementById('monthly-invoices'),
                    invoicesChange: document.getElementById('invoices-change'),
                    lowStockCount: document.getElementById('low-stock-count'),
                    inventoryValue: document.getElementById('inventory-value'),
                    inventoryChange: document.getElementById('inventory-change'),
                    invoiceSubtotal: document.getElementById('invoice-subtotal'),
                    invoiceTax: document.getElementById('invoice-tax'),
                    invoiceTotal: document.getElementById('invoice-total')
                };
            }
            
            loadData() {
                try {
                    // Load products
                    const savedProducts = localStorage.getItem('products');
                    this.products = savedProducts ? JSON.parse(savedProducts) : 
                        (typeof allProducts !== 'undefined' ? [...allProducts] : []);
                    
                    // Load invoices
                    const savedInvoices = localStorage.getItem('invoices');
                    this.invoices = savedInvoices ? JSON.parse(savedInvoices) : 
                        (typeof sampleInvoices !== 'undefined' ? [...sampleInvoices] : []);
                    
                    // Load customers
                    const savedCustomers = localStorage.getItem('customers');
                    this.customers = savedCustomers ? JSON.parse(savedCustomers) : 
                        (typeof sampleCustomers !== 'undefined' ? [...sampleCustomers] : []);
                    
                    // Load suppliers
                    const savedSuppliers = localStorage.getItem('suppliers');
                    this.suppliers = savedSuppliers ? JSON.parse(savedSuppliers) : 
                        (window.sampleSuppliers ? [...window.sampleSuppliers] : []);
                    
                    // Save sample data to localStorage if it doesn't exist
                    if (!savedProducts && this.products.length > 0) {
                        localStorage.setItem('products', JSON.stringify(this.products));
                    }
                    if (!savedInvoices && this.invoices.length > 0) {
                        localStorage.setItem('invoices', JSON.stringify(this.invoices));
                    }
                    if (!savedCustomers && this.customers.length > 0) {
                        localStorage.setItem('customers', JSON.stringify(this.customers));
                    }
                    if (!savedSuppliers && this.suppliers.length > 0) {
                        localStorage.setItem('suppliers', JSON.stringify(this.suppliers));
                    }
                    
                    console.log('Loaded suppliers:', this.suppliers);
                } catch (error) {
                    console.error('Error loading data:', error);
                    // Initialize empty arrays if there's an error
                    this.products = this.products || [];
                    this.invoices = this.invoices || [];
                    this.customers = this.customers || [];
                    this.suppliers = this.suppliers || [];
                }
            }
            
            saveData() {
                localStorage.setItem('products', JSON.stringify(this.products));
                localStorage.setItem('invoices', JSON.stringify(this.invoices));
                localStorage.setItem('customers', JSON.stringify(this.customers));
                localStorage.setItem('suppliers', JSON.stringify(this.suppliers));
            }
            
            setupEventListeners() {
                // Menu navigation
                this.menuItems.forEach(item => {
                    item.addEventListener('click', () => {
                        const page = item.dataset.page;
                        if (page) {
                            this.showPage(page);
                            window.location.hash = page;
                        }
                    });
                });
                
                // Handle hash changes
                window.addEventListener('hashchange', () => {
                    const page = window.location.hash.substring(1) || 'dashboard-page';
                    this.showPage(page);
                });
                
                // Add buttons
                this.buttons.addProduct.addEventListener('click', () => this.openProductModal());
                this.buttons.addCustomer.addEventListener('click', () => this.openCustomerModal());
                this.buttons.addSupplier.addEventListener('click', () => this.openSupplierModal());
                this.buttons.addInvoiceItem.addEventListener('click', () => this.addInvoiceItem());
                
                // Function to handle invoice button click
                function handleInvoiceButtonClick(e) {
                    e.preventDefault();
                    console.log('Add invoice button clicked');
                    this.openModal('invoice');
                }
                
                // Add click event to all buttons that contain "إضافة فاتورة" text
                const allButtons = document.getElementsByTagName('button');
                Array.from(allButtons).forEach(button => {
                    if (button.textContent.includes('إضافة فاتورة')) {
                        console.log('Found invoice button:', button);
                        button.addEventListener('click', handleInvoiceButtonClick.bind(this));
                    }
                });
                
                // Save buttons
                if (this.buttons.saveProduct) this.buttons.saveProduct.addEventListener('click', () => this.saveProduct());
                if (this.buttons.saveInvoice) this.buttons.saveInvoice.addEventListener('click', () => this.saveInvoice());
                if (this.buttons.saveCustomer) this.buttons.saveCustomer.addEventListener('click', () => this.saveCustomer());
                if (this.buttons.saveSupplier) this.buttons.saveSupplier.addEventListener('click', () => this.saveSupplier());
                
                // Cancel buttons
                if (this.buttons.cancelCustomer) this.buttons.cancelCustomer.addEventListener('click', () => this.closeModal('customer'));
                if (this.buttons.cancelSupplier) this.buttons.cancelSupplier.addEventListener('click', () => this.closeModal('supplier'));
                
                // Delete confirmation
                if (this.buttons.cancelDelete) this.buttons.cancelDelete.addEventListener('click', () => this.closeModal('delete'));
                if (this.buttons.confirmDelete) this.buttons.confirmDelete.addEventListener('click', () => this.confirmDelete());
                
                // Modal close buttons
                if (this.modalCloseButtons.product) this.modalCloseButtons.product.addEventListener('click', () => this.closeModal('product'));
                if (this.modalCloseButtons.customer) this.modalCloseButtons.customer.addEventListener('click', () => this.closeModal('customer'));
                if (this.modalCloseButtons.supplier) this.modalCloseButtons.supplier.addEventListener('click', () => this.closeModal('supplier'));
                if (this.modalCloseButtons.invoice) this.modalCloseButtons.invoice.addEventListener('click', () => this.closeModal('invoice'));
                if (this.modalCloseButtons.delete) this.modalCloseButtons.delete.addEventListener('click', () => this.closeModal('delete'));
                if (this.modalCloseButtons.cancelProduct) this.modalCloseButtons.cancelProduct.addEventListener('click', () => this.closeModal('product'));
                if (this.modalCloseButtons.cancelCustomer) this.modalCloseButtons.cancelCustomer.addEventListener('click', () => this.closeModal('customer'));
                if (this.modalCloseButtons.cancelSupplier) this.modalCloseButtons.cancelSupplier.addEventListener('click', () => this.closeModal('supplier'));
                if (this.modalCloseButtons.cancelInvoice) this.modalCloseButtons.cancelInvoice.addEventListener('click', () => this.closeModal('invoice'));
                
                // Close modals when clicking outside
                Object.values(this.modals).forEach(modal => {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeModal(modal.id.replace('-modal', ''));
                        }
                    });
                });
                
                // Search and filter events
                if (this.searchInputs.products) {
                    this.searchInputs.products.addEventListener('input', () => this.filterProducts());
                }
                if (this.searchInputs.invoices) {
                    this.searchInputs.invoices.addEventListener('input', () => this.filterInvoices());
                }
                if (this.searchInputs.suppliers) {
                    this.searchInputs.suppliers.addEventListener('input', () => this.filterSuppliers());
                }
                if (this.filterSelects.products) {
                    this.filterSelects.products.addEventListener('change', () => this.filterProducts());
                }
                if (this.filterSelects.invoices) {
                    this.filterSelects.invoices.addEventListener('change', () => this.filterInvoices());
                }
                
                // Initialize print buttons
                if (this.buttons.printInvoice) {
                    this.buttons.printInvoice.addEventListener('click', () => this.printInvoice());
                }
                
                // Add event delegation for dynamically added print buttons
                document.addEventListener('click', (e) => {
                    // Handle print buttons in invoices table
                    if (e.target.closest('.print-invoice-btn')) {
                        e.preventDefault();
                        const invoiceId = e.target.closest('.print-invoice-btn').dataset.invoiceId;
                        if (invoiceId) {
                            this.printInvoice(invoiceId);
                        }
                    }
                    
                    // Handle print buttons in customer history modal
                    if (e.target.closest('.print-invoice-history-btn')) {
                        e.preventDefault();
                        const invoiceData = JSON.parse(e.target.closest('.print-invoice-history-btn').dataset.invoice);
                        if (invoiceData) {
                            this.printInvoice(invoiceData);
                        }
                    }
                });
            }
            
            showPage(pageId) {
                console.log('Showing page:', pageId);
                // Hide all pages
                Object.values(this.pages).forEach(page => {
                    if (page) page.style.display = 'none';
                });
                
                // Show the requested page
                const pageKey = pageId.replace('-page', '');
                if (this.pages[pageKey]) {
                    this.pages[pageKey].style.display = 'block';
                }
                
                // Update active menu item
                this.menuItems.forEach(item => {
                    item.classList.remove('active');
                    if (item.dataset.page === pageId) {
                        item.classList.add('active');
                    }
                });
                
                // Update content based on the page
                switch(pageId) {
                    case 'products-page':
                        // Reset to first page when navigating to products page
                        this.currentPage.products = 1;
                        this.filterProducts(); // This will render the table with current filters
                        break;
                    case 'invoices-page':
                        this.renderInvoicesTable();
                        // Set up search and filter events
                        const invoiceSearch = document.getElementById('invoice-search');
                        const statusFilter = document.getElementById('status-invoice-filter');
                        
                        if (invoiceSearch) {
                            invoiceSearch.addEventListener('input', () => this.filterInvoices());
                        }
                        if (statusFilter) {
                            statusFilter.addEventListener('change', () => this.filterInvoices());
                        }
                        break;
                    case 'customers-page':
                        this.renderCustomersTable();
                        break;
                    case 'suppliers-page':
                        console.log('Rendering suppliers table...');
                        this.renderSuppliersTable();
                        break;
                    case 'reports-page':
                        console.log('Initializing reports page...');
                        // Make sure the reports page is visible
                        const reportsPage = document.getElementById('reports-page');
                        if (reportsPage) {
                            reportsPage.style.display = 'block';
                            // Call the updateReportsPage function if it exists
                            if (typeof window.updateReportsPage === 'function') {
                                window.updateReportsPage();
                            } else {
                                console.error('updateReportsPage function not found');
                            }
                        }
                        break;
                    case 'dashboard-page':
                        this.updateDashboard();
                        break;
                }
            }
            
            openModal(modalType, id = null) {
                this.resetForm(modalType);
                
                // Don't try to set title for delete modal as it's handled differently
                if (modalType !== 'delete') {
                    if (id) {
                        // Editing existing item
                        const item = this[`get${modalType.charAt(0).toUpperCase() + modalType.slice(1)}`](id);
                        if (item) {
                            this.fillForm(modalType, item);
                            const titleElement = document.getElementById(`${modalType}-modal-title`);
                            if (titleElement) {
                                titleElement.textContent = `تعديل ${modalType === 'product' ? 'منتج' : modalType === 'customer' ? 'عميل' : modalType === 'supplier' ? 'مورد' : 'فاتورة'}`;
                            }
                        }
                    } else {
                        // Adding new item
                        const titleElement = document.getElementById(`${modalType}-modal-title`);
                        if (titleElement) {
                            titleElement.textContent = `إضافة ${modalType === 'product' ? 'منتج جديد' : modalType === 'customer' ? 'عميل جديد' : modalType === 'supplier' ? 'مورد جديد' : 'فاتورة جديدة'}`;
                        }
                        
                        // Set default values for new items
                        if (modalType === 'invoice') {
                            this.formFields.invoice.date.value = new Date().toISOString().split('T')[0];
                            this.addInvoiceItem();
                        }
                    }
                }
                
                if (this.modals[modalType]) {
                    this.modals[modalType].classList.add('active');
                } else {
                    console.error(`Modal with type '${modalType}' not found`);
                }
            }
            
            closeModal(modalType) {
                this.modals[modalType].classList.remove('active');
                this.resetForm(modalType);
            }
            
            resetForm(modalType) {
                if (this.forms[modalType]) {
                    this.forms[modalType].reset();
                }
                
                if (modalType === 'invoice') {
                    this.tables.invoiceItems.innerHTML = '';
                }
                
                // Clear hidden ID fields
                if (this.formFields[modalType]?.id) {
                    this.formFields[modalType].id.value = '';
                }
            }
            
            fillForm(modalType, data) {
                const formFields = this.formFields[modalType];
                if (!formFields) return;
                
                formFields.id.value = data.id || '';
                
                Object.keys(data).forEach(key => {
                    if (formFields[key]) {
                        formFields[key].value = data[key] || '';
                    }
                });
                
                // Set supplier for product if it exists
                if (modalType === 'product' && data.supplierId) {
                    const supplierSelect = document.getElementById('product-supplier');
                    if (supplierSelect) {
                        supplierSelect.value = data.supplierId;
                    }
                }
            }
            
            openProductModal(id = null) {
                // Populate supplier dropdown
                const supplierSelect = document.getElementById('product-supplier');
                if (supplierSelect) {
                    // Clear existing options except the first one
                    supplierSelect.innerHTML = '<option value="">-- اختر المورد --</option>';
                    
                    // Add suppliers to the dropdown
                    this.suppliers.forEach(supplier => {
                        const option = document.createElement('option');
                        option.value = supplier.id;
                        option.textContent = supplier.name;
                        supplierSelect.appendChild(option);
                    });
                }
                
                this.openModal('product', id);
                
                // If editing existing product, select the supplier
                if (id) {
                    const product = this.getProduct(id);
                    if (product && product.supplierId && supplierSelect) {
                        supplierSelect.value = product.supplierId;
                    }
                }
            }
            
            openCustomerModal(id = null) {
                this.openModal('customer', id);
                
                if (id) {
                    const customer = this.getCustomer(id);
                    if (customer) {
                        document.getElementById('customer-name').value = customer.name;
                        document.getElementById('customer-phone').value = customer.phone;
                        document.getElementById('customer-balance').value = customer.balance || 0;
                        document.getElementById('customer-id').value = customer.id;
                        document.getElementById('customer-modal-title').textContent = 'تعديل بيانات العميل';
                    }
                } else {
                    this.resetForm('customer');
                    document.getElementById('customer-modal-title').textContent = 'إضافة عميل جديد';
                }
            }
            
            openSupplierModal(id = null) {
                this.openModal('supplier', id);
                
                if (id) {
                    const supplier = this.getSupplier(id);
                    if (supplier) {
                        document.getElementById('supplier-name').value = supplier.name;
                        document.getElementById('supplier-phone').value = supplier.phone;
                        document.getElementById('supplier-id').value = supplier.id;
                        document.getElementById('supplier-modal-title').textContent = 'تعديل بيانات المورد';
                    }
                } else {
                    this.resetForm('supplier');
                    document.getElementById('supplier-modal-title').textContent = 'إضافة مورد جديد';
                }
            }
            
            addInvoiceItem() {
                const row = document.createElement('tr');
                row.className = 'invoice-item-row';
                row.style.backgroundColor = '#fff';
                row.style.borderBottom = '1px solid #f0f0f0';
                row.innerHTML = `
                    <td style="padding: 12px 15px; text-align: right; vertical-align: middle;">
                        <select class="form-control invoice-product" required 
                                style="border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px 12px; width: 100%;">
                            <option value="">اختر منتج</option>
                            ${this.products.map(p => 
                                `<option value="${p.id}" data-balance="${p.balance}">${p.name} (${p.balance.toFixed(2)} ج.م)</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td style="padding: 12px 15px; text-align: center; vertical-align: middle; width: 200px;">
                        <input type="number" class="form-control invoice-quantity" min="1" value="1" required 
                               style="width: 100px; margin: 0 auto; text-align: center; border: 1px solid #e0e0e0; border-radius: 4px; padding: 8px;">
                    </td>
                    <td class="item-total" style="padding: 12px 15px; text-align: left; vertical-align: middle; width: 150px; font-weight: 600; color: #2c3e50;">
                        0.00 ج.م
                    </td>
                    <td style="padding: 12px 15px; text-align: center; vertical-align: middle; width: 70px;">
                        <button type="button" class="btn btn-sm remove-item" 
                                style="background: #fff; border: 1px solid #ff6b6b; color: #ff6b6b; border-radius: 4px; padding: 5px 10px; font-size: 12px; transition: all 0.2s ease;">
                            <i class="fas fa-trash"></i> حذف
                        </button>
                    </td>
                `;
                
                this.tables.invoiceItems.appendChild(row);
                
                // Add event for product selection
                const productSelect = row.querySelector('.invoice-product');
                if (productSelect) {
                    productSelect.addEventListener('change', () => {
                        this.calculateInvoiceTotal();
                    });
                }
                
                // Add quantity change event
                const quantityInput = row.querySelector('.invoice-quantity');
                if (quantityInput) {
                    quantityInput.addEventListener('input', () => this.calculateInvoiceTotal());
                }
                
                // Add remove item event
                const removeBtn = row.querySelector('.remove-item');
                if (removeBtn) {
                    removeBtn.addEventListener('click', () => {
                        if (this.tables.invoiceItems.children.length > 1) {
                            row.remove();
                            this.calculateInvoiceTotal();
                        }
                    });
                }
                
                this.calculateInvoiceTotal();
                return row;
            }
            
            calculateInvoiceTotal() {
                let total = 0;
                
                document.querySelectorAll('.invoice-item-row').forEach(row => {
                    const productSelect = row.querySelector('.invoice-product');
                    const quantity = parseFloat(row.querySelector('.invoice-quantity').value) || 0;
                    let rowTotal = 0;
                    
                    if (productSelect && productSelect.selectedIndex > 0) {
                        const selectedOption = productSelect.options[productSelect.selectedIndex];
                        const balance = selectedOption ? parseFloat(selectedOption.dataset.balance) || 0 : 0;
                        rowTotal = quantity * balance;
                    }
                    
                    // Update row total
                    const totalCell = row.querySelector('.item-total');
                    if (totalCell) {
                        totalCell.textContent = rowTotal.toFixed(2) + ' ج.م';
                    }
                    
                    total += rowTotal;
                });
                
                // Update invoice total
                const totalElement = document.getElementById('invoice-total');
                if (totalElement) {
                    totalElement.textContent = total.toFixed(2) + ' ج.م';
                }
            }
            
            saveProduct() {
                const form = this.formFields.product;
                const id = form.id.value || `prod-${Date.now()}`;
                const name = form.name.value.trim();
                const balance = parseFloat(form.balance.value);
                const quantity = parseInt(form.quantity.value, 10);
                const supplierId = document.getElementById('product-supplier').value || null;
                
                // Validate inputs
                if (!name || isNaN(balance) || balance < 0 || isNaN(quantity) || quantity < 0) {
                    this.showAlert('الرجاء ملء جميع الحقول المطلوبة بشكل صحيح', 'danger');
                    return;
                }
                
                const productData = {
                    id,
                    name,
                    balance,
                    quantity,
                    supplierId
                };
                
                // Add description if the field exists
                if (form.description && form.description.value) {
                    productData.description = form.description.value.trim();
                }
                
                if (form.id.value) {
                    // Update existing product
                    const index = this.products.findIndex(p => p.id === id);
                    if (index !== -1) {
                        this.products[index] = productData;
                        this.showAlert('تم تحديث المنتج بنجاح', 'success');
                    }
                } else {
                    // Add new product
                    this.products.push(productData);
                    this.showAlert('تم إضافة المنتج بنجاح', 'success');
                }
                
                this.saveData();
                this.closeModal('product');
                this.renderProductsTable();
                this.updateDashboard();
            }
            
            saveCustomer() {
                const form = this.formFields.customer;
                const id = form.id.value || `cust-${Date.now()}`;
                const name = form.name.value.trim();
                const phone = form.phone.value.trim();
                const balance = parseFloat(form.balance.value) || 0;
                const address = form.address ? form.address.value.trim() : '';
                
                if (!name || !phone) {
                    this.showAlert('الرجاء ملء جميع الحقول المطلوبة', 'danger');
                    return;
                }
                
                const customerData = { id, name, phone, balance };
                if (address) customerData.address = address;
                
                if (form.id.value) {
                    // Update existing customer
                    const index = this.customers.findIndex(c => c.id === id);
                    if (index !== -1) {
                        this.customers[index] = customerData;
                        this.showAlert('تم تحديث بيانات العميل بنجاح', 'success');
                    }
                } else {
                    // Add new customer
                    this.customers.push(customerData);
                    this.showAlert('تم إضافة العميل بنجاح', 'success');
                }
                
                this.saveData();
                this.closeModal('customer');
                this.renderCustomersTable();
            }
            
            saveSupplier() {
                const form = this.formFields.supplier;
                const id = form.id.value || `sup-${Date.now()}`;
                const name = form.name.value.trim();
                const phone = form.phone.value.trim();
                
                if (!name || !phone) {
                    this.showAlert('الرجاء ملء جميع الحقول المطلوبة', 'danger');
                    return;
                }
                
                const supplierData = {
                    id,
                    name,
                    phone
                };
                
                if (form.id.value) {
                    // Update existing supplier
                    const index = this.suppliers.findIndex(s => s.id === id);
                    if (index !== -1) {
                        this.suppliers[index] = supplierData;
                        this.showAlert('تم تحديث المورد بنجاح', 'success');
                    }
                } else {
                    // Add new supplier
                    this.suppliers.push(supplierData);
                    this.showAlert('تم إضافة المورد بنجاح', 'success');
                }
                
                this.saveData();
                this.closeModal('supplier');
                this.renderSuppliersTable();
            }
            
            printInvoice(invoiceIdOrData = null) {
                console.log('printInvoice called with:', invoiceIdOrData);
                let invoiceData = null;
                let invoice = null;
                
                if (invoiceIdOrData) {
                    // Check if we received an invoice object directly or an ID
                    if (typeof invoiceIdOrData === 'object' && invoiceIdOrData !== null) {
                        // Received an invoice object directly
                        invoice = invoiceIdOrData;
                        console.log('Using provided invoice data:', invoice);
                    } else {
                        // Received an invoice ID, look it up
                        console.log('Looking up invoice with ID:', invoiceIdOrData);
                        invoice = this.getInvoice(invoiceIdOrData);
                        console.log('Retrieved invoice:', invoice);
                    }
                    
                    if (!invoice) {
                        console.error('Invoice not found for:', invoiceIdOrData);
                        this.showAlert('تعذر العثور على بيانات الفاتورة', 'danger');
                        return;
                    }
                    
                    // Get customer name - handle both customer object and customerId
                    let customerName = 'عميل نقدي';
                    if (invoice.customer) {
                        // If customer object is directly included in the invoice
                        customerName = invoice.customer.name || customerName;
                    } else if (invoice.customerId) {
                        // If only customer ID is available, try to look it up
                        const customer = this.getCustomer(invoice.customerId);
                        if (customer) customerName = customer.name;
                    } else if (invoice.customerName) {
                        // If customer name is directly in the invoice
                        customerName = invoice.customerName;
                    }
                    
                    // Prepare items data
                    const items = [];
                    console.log('Original invoice items:', JSON.stringify(invoice.items, null, 2));
                    
                    // First, try to get items from the invoice
                    const invoiceItems = Array.isArray(invoice.items) ? invoice.items : [];
                    
                    // If no items found, try to find items in other possible properties
                    const possibleItemArrays = [];
                    if (invoiceItems.length === 0) {
                        // Look for arrays that might contain items
                        Object.keys(invoice).forEach(key => {
                            if (Array.isArray(invoice[key]) && key.toLowerCase() !== 'items') {
                                console.log(`Found potential items array in property '${key}':`, invoice[key]);
                                possibleItemArrays.push(...invoice[key]);
                            }
                        });
                    }
                    
                    // Combine all possible items
                    const allPossibleItems = [...invoiceItems, ...possibleItemArrays];
                    
                    console.log('Processing all possible items:', allPossibleItems);
                    
                    // Process all items
                    allPossibleItems.forEach(item => {
                        if (!item) return;
                        
                        console.log('Processing item:', item);
                        
                        // Try to find the product in the allProducts array first
                        let productName = 'منتج غير معروف';
                        let productPrice = 0;
                        
                        // First try to find by ID in allProducts
                        const productId = item.id || item.productId;
                        if (productId) {
                            const product = window.allProducts.find(p => p.id === productId);
                            if (product) {
                                productName = product.name;
                                productPrice = parseFloat(product.balance) || 0;
                            }
                        }
                        
                        // If still not found, try to find by name in allProducts
                        if (productName === 'منتج غير معروف' && item.productName) {
                            const product = window.allProducts.find(p => p.name === item.productName);
                            if (product) {
                                productName = product.name;
                                productPrice = parseFloat(product.balance) || 0;
                            }
                        }
                        
                        // Fall back to item properties if product not found in allProducts
                        if (productName === 'منتج غير معروف') {
                            productName = item.productName || item.name || item.product?.name || 'منتج غير معروف';
                            productPrice = parseFloat(item.balance || item.price || item.product?.price || 0);
                        }
                        
                        const quantity = parseFloat(item.quantity) || 0;
                        const balance = parseFloat(item.balance || item.price || productPrice || 0);
                        
                        console.log(`Item details - ID: ${item.id || 'N/A'}, Name: ${productName}, Qty: ${quantity}, Price: ${balance}`);
                        
                        if (productName || balance > 0) {
                            items.push({
                                id: item.id,
                                productId: item.productId,
                                productName: productName,
                                quantity: quantity,
                                balance: balance,
                                total: quantity * balance
                            });
                        }
                    });
                    
                    console.log('Processed items for printing:', items);
                    
                    // If still no items, try to extract from the invoice data directly
                    if (items.length === 0) {
                        console.log('No items found in standard locations, trying direct extraction');
                        
                        // Look for any array in the invoice that might contain items
                        Object.keys(invoice).forEach(key => {
                            if (Array.isArray(invoice[key])) {
                                console.log(`Checking array in '${key}':`, invoice[key]);
                                invoice[key].forEach((potentialItem, index) => {
                                    if (potentialItem && (potentialItem.quantity || potentialItem.balance || potentialItem.price)) {
                                        const productName = potentialItem.productName || 
                                                         potentialItem.name || 
                                                         potentialItem.product?.name || 
                                                         `منتج ${index + 1}`;
                                        const quantity = parseFloat(potentialItem.quantity) || 0;
                                        const balance = parseFloat(potentialItem.balance || potentialItem.price || 0);
                                        
                                        items.push({
                                            productName: productName,
                                            quantity: quantity,
                                            balance: balance,
                                            total: quantity * balance
                                        });
                                    }
                                });
                            }
                        });
                        
                        console.log('Items after direct extraction:', items);
                    }
                    
                    // Prepare invoice data for printing
                    const subtotal = items.reduce((sum, item) => {
                        return sum + (parseFloat(item.balance) * parseFloat(item.quantity) || 0);
                    }, 0);
                    
                    // Ensure all items have the correct structure
                    const formattedItems = items.map(item => ({
                        productName: item.productName || 'منتج غير معروف',
                        quantity: parseFloat(item.quantity) || 0,
                        balance: parseFloat(item.balance) || 0,
                        total: (parseFloat(item.quantity) * parseFloat(item.balance)) || 0
                    }));
                    
                    invoiceData = {
                        invoiceNumber: invoice.id || `INV-${Date.now()}`,
                        customerName: customerName,
                        date: invoice.date || new Date().toISOString(),
                        items: formattedItems,
                        subtotal: parseFloat(invoice.subtotal) || subtotal,
                        tax: parseFloat(invoice.tax) || 0,
                        total: parseFloat(invoice.total) || (subtotal + (parseFloat(invoice.tax) || 0)),
                        status: invoice.status || 'unpaid'
                    };
                    
                    console.log('Prepared invoice data for printing:', JSON.stringify(invoiceData, null, 2));
                } else {
                    // Print from invoice modal - get data from form
                    const customerSelect = document.getElementById('invoice-customer');
                    const customerName = customerSelect?.options[customerSelect.selectedIndex]?.text || 'عميل نقدي';
                    
                    // Get invoice items from form
                    const items = [];
                    
                    document.querySelectorAll('.invoice-item-row').forEach(row => {
                        const productSelect = row.querySelector('.invoice-product');
                        if (productSelect && productSelect.selectedIndex > 0) {
                            const productName = productSelect.options[productSelect.selectedIndex].text.split('(')[0].trim();
                            const quantity = parseFloat(row.querySelector('.invoice-quantity')?.value) || 0;
                            const balance = parseFloat(productSelect.options[productSelect.selectedIndex].dataset.balance) || 0;
                            
                            if (productName && quantity > 0) {
                                items.push({
                                    productName: productName,
                                    quantity: quantity,
                                    balance: balance
                                });
                            }
                        }
                    });
                    
                    // Calculate totals if not available
                    const subtotal = parseFloat(this.dashboardElements?.invoiceSubtotal?.textContent) || 
                                   items.reduce((sum, item) => sum + (item.quantity * item.balance), 0);
                    const tax = parseFloat(this.dashboardElements?.invoiceTax?.textContent) || 0;
                    const total = parseFloat(this.dashboardElements?.invoiceTotal?.textContent) || (subtotal + tax);
                    
                    // Prepare invoice data
                    invoiceData = {
                        invoiceNumber: document.getElementById('invoice-id')?.value || 'جديد',
                        customerName: customerName,
                        date: document.getElementById('invoice-date')?.value || new Date().toISOString().split('T')[0],
                        items: items,
                        subtotal: subtotal,
                        tax: tax,
                        total: total,
                        status: 'unpaid'
                    };
                }
                
                if (!invoiceData || !Array.isArray(invoiceData.items) || invoiceData.items.length === 0) {
                    this.showAlert('لا توجد عناصر في الفاتورة للطباعة', 'warning');
                    return;
                }
                
                console.log('Prepared invoice data:', invoiceData);
                
                try {
                    // Encode the invoice data for URL
                    const encodedData = encodeURIComponent(JSON.stringify(invoiceData));
                    console.log('Encoded data length:', encodedData.length);
                    
                    // Open print page with data in URL hash
                    const printUrl = `print-invoice.html#${encodedData}`;
                    console.log('Opening URL:', printUrl);
                    
                    const printWindow = window.open(printUrl, '_blank');
                    
                    if (!printWindow) {
                        throw new Error('Failed to open print window. Please allow popups for this site.');
                    }
                    
                    // Also try to send via postMessage as a fallback
                    let messageSent = false;
                    const checkPrintWindow = setInterval(() => {
                        try {
                            if (!messageSent) {
                                console.log('Sending postMessage to print window');
                                printWindow.postMessage({ 
                                    type: 'PRINT_INVOICE', 
                                    data: invoiceData 
                                }, '*');
                                messageSent = true;
                            }
                            clearInterval(checkPrintWindow);
                        } catch (e) {
                            console.log('Window not ready yet, will retry...');
                        }
                    }, 100);
                    
                    setTimeout(() => {
                        clearInterval(checkPrintWindow);
                        console.log('Print window timeout reached');
                    }, 3000);
                    
                } catch (error) {
                    console.error('Error in printInvoice:', error);
                    this.showAlert(`خطأ في فتح نافذة الطباعة: ${error.message}`, 'danger');
                }
            }
            
            saveInvoice() {
                const form = this.formFields.invoice;
                const id = form.id.value || `INV-${Date.now().toString().substr(-6)}`;
                const customerId = form.customer.value;
                const date = form.date.value;
                
                // Validate inputs
                if (!customerId || !date) {
                    this.showAlert('الرجاء ملء جميع الحقول المطلوبة', 'danger');
                    return;
                }
                
                // Collect invoice items
                const items = [];
                let isValid = true;
                
                document.querySelectorAll('.invoice-item-row').forEach(row => {
                    const productId = row.querySelector('.invoice-product').value;
                    const quantity = parseInt(row.querySelector('.invoice-quantity').value, 10);
                    const balance = parseFloat(row.querySelector('.invoice-balance').value);
                    const discount = parseFloat(row.querySelector('.invoice-discount').value) || 0;
                    
                    if (!productId || isNaN(quantity) || quantity <= 0 || isNaN(balance) || balance < 0) {
                        isValid = false;
                        return;
                    }
                    
                    items.push({ productId, quantity, balance, discount });
                });
                
                if (!isValid || items.length === 0) {
                    this.showAlert('الرجاء إدخال جميع بنود الفاتورة بشكل صحيح', 'danger');
                    return;
                }
                
                // Get customer name
                const customer = this.getCustomer(customerId);
                const customerName = customer ? customer.name : 'عميل نقدي';
                
                // Calculate totals
                const subtotal = parseFloat(this.dashboardElements.invoiceSubtotal.textContent);
                const tax = parseFloat(this.dashboardElements.invoiceTax.textContent);
                const total = parseFloat(this.dashboardElements.invoiceTotal.textContent);
                
                const invoiceData = {
                    id,
                    customerId,
                    customer: customerName,
                    date,
                    items,
                    subtotal,
                    tax,
                    total
                };
                
                if (form.id.value) {
                    // Update existing invoice
                    const index = this.invoices.findIndex(i => i.id === id);
                    if (index !== -1) {
                        this.invoices[index] = invoiceData;
                        this.showAlert('تم تحديث الفاتورة بنجاح', 'success');
                    }
                } else {
                    // Add new invoice
                    this.invoices.unshift(invoiceData);
                    
                    // Update product quantities
                    items.forEach(item => {
                        const product = this.getProduct(item.productId);
                        if (product) {
                            product.quantity -= item.quantity;
                            if (product.quantity < 0) product.quantity = 0;
                        }
                    });
                    
                    this.showAlert('تم إضافة الفاتورة بنجاح', 'success');
                }
                
                this.saveData();
                this.closeModal('invoice');
                this.renderInvoicesTable();
                this.renderProductsTable();
                this.updateDashboard();
            }
            
            confirmDelete() {
                if (this.currentDeleteId && this.currentDeleteType) {
                    if (this.currentDeleteType === 'product') {
                        this.deleteProduct(this.currentDeleteId);
                    } else if (this.currentDeleteType === 'invoice') {
                        this.deleteInvoice(this.currentDeleteId);
                    } else if (this.currentDeleteType === 'customer') {
                        this.deleteCustomer(this.currentDeleteId);
                    } else if (this.currentDeleteType === 'supplier') {
                        this.deleteSupplier(this.currentDeleteId);
                    }
                    this.closeModal('delete');
                    this.currentDeleteId = null;
                    this.currentDeleteType = null;
                }
            }
            
            deleteProduct(id) {
                this.products = this.products.filter(p => p.id !== id);
                this.saveData();
                this.showAlert('تم حذف المنتج بنجاح', 'success');
                this.renderProductsTable();
                this.updateDashboard();
            }
            
            deleteInvoice(id) {
                this.invoices = this.invoices.filter(i => i.id !== id);
                this.saveData();
                this.showAlert('تم حذف الفاتورة بنجاح', 'success');
                this.renderInvoicesTable();
                this.updateDashboard();
            }
            
            deleteCustomer(id) {
                this.customers = this.customers.filter(c => c.id !== id);
                this.saveData();
                this.showAlert('تم حذف العميل بنجاح', 'success');
                this.renderCustomersTable();
            }
            
            deleteSupplier(id) {
                this.suppliers = this.suppliers.filter(s => s.id !== id);
                this.saveData();
                this.showAlert('تم حذف المورد بنجاح', 'success');
                this.renderSuppliersTable();
            }
            
            showDeleteConfirmation(id, type, message) {
                this.currentDeleteId = id;
                this.currentDeleteType = type;
                document.getElementById('delete-message').textContent = message || 'هل أنت متأكد أنك تريد حذف هذا العنصر؟ لا يمكن التراجع عن هذا الإجراء.';
                this.openModal('delete');
            }
            
            getProduct(id) {
                return this.products.find(p => p.id === id);
            }
            
            getInvoice(id) {
                return this.invoices.find(i => i.id === id);
            }
            
            getCustomer(id) {
                return this.customers.find(customer => customer.id === id);
            }
            
            getSupplier(id) {
                return this.suppliers.find(supplier => supplier.id === id);
            }
            
            filterProducts() {
                const searchTerm = this.searchInputs.products.value.toLowerCase();
                const status = this.filterSelects.products.value;
                
                let filtered = [...this.products];
                
                // Apply search
                if (searchTerm) {
                    filtered = filtered.filter(p => 
                        p.name.toLowerCase().includes(searchTerm) || 
                        (p.description && p.description.toLowerCase().includes(searchTerm))
                    );
                }
                
                // Apply status filter
                if (status !== 'all') {
                    if (status === 'available') {
                        filtered = filtered.filter(p => p.quantity > 10);
                    } else if (status === 'low') {
                        filtered = filtered.filter(p => p.quantity > 0 && p.quantity <= 10);
                    } else if (status === 'out') {
                        filtered = filtered.filter(p => p.quantity === 0);
                    }
                }
                
                this.renderProductsTable(filtered);
            }
            
            filterInvoices() {
                const searchInput = document.getElementById('invoice-search');
                const statusFilter = document.getElementById('status-invoice-filter');
                
                if (!searchInput || !statusFilter) {
                    console.error('Search input or status filter not found');
                    this.renderInvoicesTable();
                    return;
                }
                
                const searchTerm = searchInput.value.toLowerCase();
                const statusValue = statusFilter.value;
                
                const filteredInvoices = this.invoices.filter(invoice => {
                    const matchesSearch = 
                        (invoice.id && invoice.id.toLowerCase().includes(searchTerm)) ||
                        (invoice.customer && invoice.customer.toString().toLowerCase().includes(searchTerm)) ||
                        (invoice.date && invoice.date.toString().includes(searchTerm));
                        
                    const matchesStatus = statusValue === 'all' || invoice.status === statusValue;
                    
                    return matchesSearch && matchesStatus;
                });
                
                // Render the filtered invoices
                const tbody = document.getElementById('invoices-table-body');
                if (!tbody) return;
                
                // Clear existing rows
                tbody.innerHTML = '';
                
                if (filteredInvoices.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-receipt"></i>
                                    <h3>لا توجد فواتير متطابقة مع معايير البحث</h3>
                                    <p>حاول تغيير كلمات البحث أو فلتر الحالة</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }
                
                // Render the filtered invoices
                filteredInvoices.forEach((invoice, index) => {
                    const row = document.createElement('tr');
                    row.className = 'fade-in';
                    
                    // Format status
                    let statusClass = '';
                    let statusText = '';
                    
                    switch(invoice.status) {
                        case 'sales':
                            statusClass = 'info';
                            statusText = 'فاتورة مبيعات';
                            break;
                        case 'paid':
                            statusClass = 'success';
                            statusText = 'مدفوعة';
                            break;
                        case 'unpaid':
                            statusClass = 'danger';
                            statusText = 'غير مدفوعة';
                            break;
                        case 'partial':
                            statusClass = 'warning';
                            statusText = 'مدفوعة جزئياً';
                            break;
                        default:
                            statusClass = 'secondary';
                            statusText = 'غير معروفة';
                    }
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td>${invoice.customer || 'غير محدد'}</td>
                        <td>${invoice.date || 'غير محدد'}</td>
                        <td>${(invoice.total || 0).toFixed(2)} ج.م</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn print-invoice-btn" 
                                    data-invoice-id="${invoice.id}" 
                                    title="طباعة الفاتورة">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
            }
            
            filterSuppliers() {
                const searchTerm = this.searchInputs.suppliers?.value?.toLowerCase() || '';
                
                if (!searchTerm) {
                    this.renderSuppliersTable();
                    return;
                }
                
                const filteredSuppliers = this.suppliers.filter(supplier => 
                    (supplier.name?.toLowerCase().includes(searchTerm) || false) ||
                    (supplier.phone?.includes(searchTerm) || false)
                );
                
                this.renderSuppliersTable(filteredSuppliers);
            }
            
            filterProducts() {
                const searchTerm = (this.searchInputs.products?.value || '').toLowerCase();
                const statusFilter = this.filterSelects.products?.value || 'all';
                
                // If no search term and no filter, show all products
                if (!searchTerm && statusFilter === 'all') {
                    this.renderProductsTable(this.products);
                    return;
                }
                
                let filteredProducts = this.products.filter(product => {
                    // Filter by search term
                    const matchesSearch = !searchTerm || 
                        product.name.toLowerCase().includes(searchTerm) ||
                        (product.description && product.description.toLowerCase().includes(searchTerm));
                    
                    // Filter by status
                    let matchesStatus = true;
                    if (statusFilter === 'available') {
                        matchesStatus = product.quantity > 10;
                    } else if (statusFilter === 'low') {
                        matchesStatus = product.quantity > 0 && product.quantity <= 10;
                    } else if (statusFilter === 'out') {
                        matchesStatus = product.quantity === 0;
                    }
                    
                    return matchesSearch && matchesStatus;
                });
                
                // Reset to first page when filtering
                this.currentPage.products = 1;
                
                // Store filtered products and render the table
                this.filteredProducts = filteredProducts;
                this.renderProductsTable(filteredProducts);
            }
            
            renderProductsTable(productsList = this.products) {
                // Store the filtered products for pagination
                this.filteredProducts = productsList;
                
                const startIndex = (this.currentPage.products - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const paginatedProducts = productsList.slice(startIndex, endIndex);
                
                this.tables.products.innerHTML = '';
                
                if (paginatedProducts.length === 0) {
                    this.tables.products.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-box-open"></i>
                                <h3>لا توجد منتجات متاحة</h3>
                                <p>استخدم زر "إضافة منتج جديد" لإضافة منتجات إلى المخزون</p>
                            </td>
                        </tr>
                    `;
                    this.pagination.products.style.display = 'none';
                    return;
                }
                
                // Show pagination if there are multiple pages
                if (productsList.length > this.itemsPerPage) {
                    this.renderPagination('products', productsList.length);
                } else {
                    this.pagination.products.style.display = 'none';
                }
                
                paginatedProducts.forEach((product, index) => {
                    const row = document.createElement('tr');
                    const actualIndex = startIndex + index + 1;
                    
                    // Determine product status
                    let statusClass, statusText;
                    if (product.quantity === 0) {
                        statusClass = 'status-danger';
                        statusText = 'منتهي';
                    } else if (product.quantity <= 10) {
                        statusClass = 'status-warning';
                        statusText = 'كمية منخفضة';
                    } else {
                        statusClass = 'status-success';
                        statusText = 'متوفر';
                    }
                    
                    row.innerHTML = `
                        <td>${actualIndex}</td>
                        <td>${product.name}</td>
                        <td>${product.balance.toFixed(2)}</td>
                        <td class="${product.quantity === 0 ? 'no-stock' : (product.quantity <= 10 ? 'low-stock' : '')}">
                            ${product.quantity}
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn edit" data-id="${product.id}" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" data-id="${product.id}" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="action-btn history" data-id="${product.id}" title="سجل المعاملات">
                                <i class="fas fa-history"></i>
                            </button>
                        </td>
                    `;
                    
                    this.tables.products.appendChild(row);
                    
                    // Add event listeners to buttons
                    row.querySelector('.action-btn.edit').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.openProductModal(product.id);
                    });
                    
                    row.querySelector('.action-btn.delete').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showDeleteConfirmation(
                            product.id, 
                            'product', 
                            `هل أنت متأكد أنك تريد حذف المنتج "${product.name}"؟ لا يمكن التراجع عن هذا الإجراء.`
                        );
                    });
                    
                    row.querySelector('.action-btn.history').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.showProductHistory(product.id);
                    });
                });

                // Handle print button clicks
                document.querySelectorAll('#customer-history-modal .action-btn[title="طباعة"]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const invoiceId = e.currentTarget.getAttribute('data-id');
                        this.printInvoice(invoiceId);
                    });
                });
            }

            renderInvoicesTable() {
                const tbody = document.getElementById('invoices-table-body');
                if (!tbody) return;
                
                // Clear existing rows
                tbody.innerHTML = '';
                
                // Get all invoices, sorted by date (newest first)
                const sortedInvoices = [...this.invoices].sort((a, b) => new Date(b.date) - new Date(a.date));
                
                // Calculate pagination
                const startIndex = (this.currentPage.invoices - 1) * this.itemsPerPage;
                const endIndex = startIndex + this.itemsPerPage;
                const paginatedInvoices = sortedInvoices.slice(startIndex, endIndex);
                
                if (paginatedInvoices.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-file-invoice"></i>
                                    <h3>لا توجد فواتير</h3>
                                    <p>قم بإضافة فواتير جديدة لعرضها هنا</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }
                
                // Add invoice rows
                paginatedInvoices.forEach((invoice, index) => {
                    const row = document.createElement('tr');
                    const rowNumber = startIndex + index + 1;
                    
                    // Get customer name
                    let customerName = 'عميل نقدي';
                    if (invoice.customerId) {
                        const customer = this.getCustomer(invoice.customerId);
                        if (customer) {
                            customerName = customer.name;
                        } else if (invoice.customer) {
                            customerName = invoice.customer;
                        }
                    } else if (invoice.customer) {
                        customerName = invoice.customer;
                    }
                    
                    // Determine status
                    const isPaid = invoice.status === 'paid';
                    const statusText = isPaid ? 'مدفوعة' : 'غير مدفوعة';
                    const statusClass = isPaid ? 'status-success' : 'status-danger';
                    
                    // Format date
                    const formattedDate = invoice.date ? new Date(invoice.date).toLocaleDateString('ar-EG') : 'غير محدد';
                    
                    // Create row HTML with print button using the new class
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td>${customerName}</td>
                        <td>${formattedDate}</td>
                        <td>${(invoice.total || 0).toFixed(2)} ج.م</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn print-invoice-btn" 
                                    data-invoice-id="${invoice.id}" 
                                    title="طباعة الفاتورة">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                    
                    tbody.appendChild(row);
                });
                
                // Render pagination
                this.renderPagination('invoices', sortedInvoices.length);
            }
            
            showSupplierHistory(supplierId) {
                console.log('showSupplierHistory called with ID:', supplierId);
                try {
                    console.log('Creating loading modal...');
                    // Show loading state
                    const loadingHtml = `
                        <div class="modal-overlay active" id="supplier-history-modal">
                            <div class="modal" style="max-width: 800px;">
                                <div class="modal-header">
                                    <h3>جاري التحميل...</h3>
                                    <button class="close-btn" id="close-supplier-history">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="modal-body" style="text-align: center; padding: 40px;">
                                    <div class="spinner" style="font-size: 2em; margin-bottom: 20px;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                    </div>
                                    <p>جاري تحميل سجل المورد...</p>
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove any existing supplier history modal
                    const existingModal = document.getElementById('supplier-history-modal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    // Add loading modal to the page
                    document.body.insertAdjacentHTML('beforeend', loadingHtml);

                    // Get supplier data
                    console.log('Fetching supplier with ID:', supplierId);
                    const supplier = this.getSupplier(supplierId);
                    console.log('Retrieved supplier:', supplier);
                    if (!supplier) {
                        console.error('Supplier not found with ID:', supplierId);
                        this.showAlert('المورد غير موجود', 'error');
                        closeModal();
                        return;
                    }

                    // Calculate totals
                    console.log('Processing supplier items history...');
                    const items = Array.isArray(supplier.itemsHistory) ? supplier.itemsHistory : [];
                    console.log(`Found ${items.length} items in history`);
                    
                    const totalPurchases = items.reduce((sum, item) => {
                        const quantity = parseFloat(item.quantity) || 0;
                        const price = parseFloat(item.price) || 0;
                        const itemTotal = quantity * price;
                        console.log(`Item: ${item.name || 'Unnamed'}, Qty: ${quantity}, Price: ${price}, Total: ${itemTotal}`);
                        return sum + itemTotal;
                    }, 0);
                    console.log('Total purchases:', totalPurchases);

                    const totalItems = items.reduce((sum, item) => {
                        const qty = parseFloat(item.quantity) || 0;
                        return sum + qty;
                    }, 0);
                    console.log('Total items:', totalItems);

                    // Log supplier transaction history in a clear format
                    console.log('%c=== سجل معاملات المورد ===', 'font-size: 16px; font-weight: bold; color: #2c3e50;');
                    console.log(`اسم المورد: ${supplier.name || 'غير معروف'}`);
                    console.log(`رقم الهاتف: ${supplier.phone || 'غير محدد'}`);
                    console.log(`عدد المعاملات: ${items.length}`);
                    console.log('----------------------------------------');
                    
                    // Format items with proper error handling
                    console.log('Formatting items for display...');
                    const formattedItems = items.map((item, index) => {
                        // Log each transaction in a table format
                        console.groupCollapsed(`🔹 معاملة #${index + 1}: ${item.name || 'منتج غير معروف'}`);
                        console.table({
                            'التاريخ': item.date ? new Date(item.date).toLocaleString('ar-EG') : 'غير محدد',
                            'المنتج': item.name || 'غير معروف',
                            'الكمية': item.quantity || 0,
                            'الوحدة': item.unit || 'وحدة',
                            'سعر الوحدة': `${(item.price || 0).toFixed(2)} ج.م`,
                            'الإجمالي': `${((item.quantity || 0) * (item.price || 0)).toFixed(2)} ج.م`,
                            'رقم الدفعة': item.batch || 'غير محدد',
                            'ملاحظات': item.notes || 'لا توجد'
                        });
                        console.groupEnd();
                        console.log(`Formatting item ${index + 1}:`, item);
                        try {
                            const itemDate = item.date ? new Date(item.date) : new Date();
                            const formattedDate = itemDate.toLocaleDateString('ar-EG', {
                                year: 'numeric',
                                month: 'long',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                            
                            const quantity = parseFloat(item.quantity) || 0;
                            const price = parseFloat(item.price) || 0;
                            const total = quantity * price;
                            
                            return {
                                ...item,
                                formattedDate,
                                quantity,
                                price,
                                total
                            };
                        } catch (error) {
                            console.error('Error formatting item:', item, error);
                            console.error('Error formatting item:', error);
                            return null;
                        }
                    }).filter(Boolean);
                    console.log(`Successfully formatted ${formattedItems.length} items`);

                    // Sort items by date (newest first)
                    console.log('Sorting items by date...');
                    formattedItems.sort((a, b) => {
                        const dateA = new Date(a.date);
                        const dateB = new Date(b.date);
                        console.log(`Comparing dates: ${a.date} (${dateA}) vs ${b.date} (${dateB})`);
                        return dateB - dateA;
                    });
                    console.log('Items after sorting:', formattedItems);
                    
                    // Log summary at the end
                    console.log('\n%c=== ملخص المعاملات ===', 'font-size: 14px; font-weight: bold; color: #27ae60;');
                    console.log(`إجمالي المشتريات: ${totalPurchases.toFixed(2)} ج.م`);
                    console.log(`إجمالي الكميات: ${totalItems} وحدة`);
                    console.log(`متوسط سعر الوحدة: ${items.length > 0 ? (totalPurchases / totalItems).toFixed(2) : 0} ج.م`);
                    console.log('==================================');

                    // Create modal HTML
                    const modalHtml = `
                        <div class="modal-overlay active" id="supplier-history-modal">
                            <div class="modal" style="max-width: 800px; max-height: 90vh; display: flex; flex-direction: column;">
                                <div class="modal-header" style="flex-shrink: 0;">
                                    <h3>سجل معاملات المورد: ${supplier.name || 'غير معروف'}</h3>
                                    <button class="close-btn" id="close-supplier-history">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="modal-body" style="overflow-y: auto; padding: 0 20px 20px; flex-grow: 1;">
                                    <div class="supplier-info" style="margin: 15px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div><strong>رقم الهاتف:</strong> ${supplier.phone || 'غير محدد'}</div>
                                        <div><strong>إجمالي المشتريات:</strong> ${totalPurchases.toFixed(2)} ج.م</div>
                                        <div><strong>عدد العناصر المشتراة:</strong> ${totalItems}</div>
                                        <div><strong>عدد المعاملات:</strong> ${items.length}</div>
                                    </div>
                                    
                                    <div class="items-list">
                                        <div style="display: flex; justify-content: space-between; align-items: center; margin: 20px 0 15px; padding-bottom: 8px; border-bottom: 2px solid var(--primary);">
                                            <h4 style="margin: 0; color: var(--primary);">سجل المشتريات</h4>
                                            <span class="badge" style="background: var(--primary); color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.9em;">
                                                ${items.length} معاملة
                                            </span>
                                        </div>
                                        
                                        ${items.length > 0 
                                            ? formattedItems.map((item, index) => `
                                                <div class="item-card" style="margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; overflow: hidden; transition: all 0.3s ease;">
                                                    <div class="item-header" style="background: #f8f9fa; padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                        <div style="display: flex; flex-direction: column; gap: 5px;">
                                                            <div style="display: flex; gap: 10px; align-items: center;">
                                                                <i class="fas fa-box" style="color: #666;"></i>
                                                                <span class="item-name" style="font-weight: bold; font-size: 1.1em;">${item.name || 'منتج غير معروف'}</span>
                                                            </div>
                                                            <div style="display: flex; gap: 10px; font-size: 0.9em; color: #666;">
                                                                <span class="item-date">
                                                                    <i class="far fa-calendar-alt"></i> ${item.formattedDate}
                                                                </span>
                                                            </div>
                                                        </div>
                                                        <div style="display: flex; align-items: center; gap: 15px;">
                                                            <span class="item-total" style="font-weight: bold; color: var(--secondary); font-size: 1.2em;">
                                                                ${item.total.toFixed(2)} ج.م
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="item-details" style="padding: 15px; background: white;">
                                                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                                                <span style="color: #666;">الكمية:</span>
                                                                <span style="font-weight: 500;">${item.quantity} ${item.unit || 'وحدة'}</span>
                                                            </div>
                                                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                                                <span style="color: #666;">سعر الوحدة:</span>
                                                                <span style="font-weight: 500;">${item.price.toFixed(2)} ج.م</span>
                                                            </div>
                                                            ${item.batch ? `
                                                                <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0; grid-column: span 2;">
                                                                    <span style="color: #666;">رقم الدفعة:</span>
                                                                    <span style="font-weight: 500;">${item.batch}</span>
                                                                </div>
                                                            ` : ''}
                                                            ${item.notes ? `
                                                                <div style="grid-column: span 2; margin-top: 10px; padding-top: 10px; border-top: 1px dashed #eee;">
                                                                    <div style="color: #666; margin-bottom: 5px;">ملاحظات:</div>
                                                                    <div style="background: #f9f9f9; padding: 8px; border-radius: 4px; font-size: 0.9em;">
                                                                        ${item.notes}
                                                                    </div>
                                                                </div>
                                                            ` : ''}
                                                        </div>
                                                    </div>
                                                </div>`).join('')
                                            : `<div class="no-items" style="text-align: center; padding: 40px 20px; color: #666; background: #f9f9f9; border-radius: 8px; margin: 20px 0;">
                                                <i class="fas fa-box-open" style="font-size: 3em; margin-bottom: 15px; opacity: 0.3;"></i>
                                                <h4 style="margin: 0 0 10px; color: #555;">لا توجد معاملات مسجلة</h4>
                                                <p style="margin: 0; opacity: 0.8;">لم يتم تسجيل أي مشتريات لهذا المورد بعد</p>
                                            </div>`}
                                    </div>
                                </div>
                                <div class="modal-footer" style="padding: 15px; border-top: 1px solid #eee; text-align: left; flex-shrink: 0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                        <div style="font-weight: 500; color: #555;">
                                            إجمالي المشتريات: <span style="color: var(--primary); font-weight: bold;">${totalPurchases.toFixed(2)} ج.م</span>
                                        </div>
                                        <div>
                                            <button class="btn btn-outline" id="close-supplier-history-btn" style="padding: 8px 20px; margin-left: 10px;">
                                                <i class="fas fa-times"></i> إغلاق
                                            </button>
                                            ${items.length > 0 ? `
                                                <button class="btn btn-primary" id="print-supplier-history" style="padding: 8px 20px;">
                                                    <i class="fas fa-print"></i> طباعة السجل
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Update the modal with actual content
                    console.log('Updating modal with formatted content...');
                    const modalContainer = document.getElementById('supplier-history-modal');
                    if (modalContainer) {
                        console.log('Found existing modal container, replacing content...');
                        modalContainer.outerHTML = modalHtml;
                        console.log('Setting up event listeners...');
                        this.setupSupplierHistoryEventListeners();
                        console.log('Modal update complete');
                    } else {
                        console.error('Modal container not found!');
                    }

                } catch (error) {
                    console.error('Error showing supplier history:', error);
                    this.showAlert('حدث خطأ غير متوقع أثناء تحميل سجل المورد', 'error');
                    closeModal();
                }
            }

            setupSupplierHistoryEventListeners() {
                console.log('Setting up supplier history event listeners...');
                // Close modal function
                const closeModal = () => {
                    console.log('Closing supplier history modal...');
                    const modal = document.getElementById('supplier-history-modal');
                    if (modal) modal.remove();
                };

                // Close modal when clicking close button or overlay
                const closeBtn1 = document.getElementById('close-supplier-history');
                const closeBtn2 = document.getElementById('close-supplier-history-btn');
                
                console.log('Close button 1:', closeBtn1 ? 'Found' : 'Not found');
                console.log('Close button 2:', closeBtn2 ? 'Found' : 'Not found');
                
                closeBtn1?.addEventListener('click', () => {
                    console.log('Close button 1 clicked');
                    closeModal();
                });
                
                closeBtn2?.addEventListener('click', () => {
                    console.log('Close button 2 clicked');
                    closeModal();
                });
                
                // Close when clicking overlay (outside modal content)
                const overlay = document.querySelector('#supplier-history-modal .modal-overlay');
                console.log('Overlay element:', overlay ? 'Found' : 'Not found');
                if (overlay) {
                    overlay.addEventListener('click', (e) => {
                        console.log('Overlay clicked, checking if click is outside modal...');
                        if (e.target === e.currentTarget) {
                            console.log('Click is outside modal, closing...');
                            closeModal();
                        }
                    });
                }

                // Print functionality
                const printBtn = document.getElementById('print-supplier-history');
                console.log('Print button:', printBtn ? 'Found' : 'Not found');
                if (printBtn) {
                    printBtn.addEventListener('click', () => {
                        console.log('Print button clicked');
                        try {
                            window.print();
                            console.log('Print dialog opened successfully');
                        } catch (error) {
                            console.error('Error opening print dialog:', error);
                        }
                    });
                }

                // Close modal when pressing Escape key
                const handleEscKey = (e) => {
                    if (e.key === 'Escape') {
                        closeModal();
                        document.removeEventListener('keydown', handleEscKey);
                    }
                };
                document.addEventListener('keydown', handleEscKey);
            }
            
            showProductHistory(productId) {
                try {
                    console.log('Showing product history for product ID:', productId);
                    const product = this.getProduct(productId);
                    if (!product) {
                        console.error('Product not found with ID:', productId);
                        this.showAlert('المنتج غير موجود', 'error');
                        return;
                    }
                    console.log('Product found:', product.name, product);

                    // Get supplier history for this product
                    console.log('Getting supplier history for product:', product.name);
                    const supplierHistory = product.supplierHistory || [];
                    console.log('Raw supplier history:', supplierHistory);
                    
                    const supplierIds = [...new Set(supplierHistory.map(item => item.supplierId))];
                    console.log('Unique supplier IDs:', supplierIds);
                    
                    const suppliers = supplierIds.map(id => {
                        const supplier = this.getSupplier(id);
                        console.log(`Supplier ${id}:`, supplier);
                        return supplier;
                    }).filter(Boolean);
                    
                    console.log('Filtered suppliers:', suppliers);

                    // Create modal HTML
                    const modalHtml = `
                        <div class="modal-overlay active" id="product-history-modal">
                            <div class="modal" style="max-width: 900px;">
                                <div class="modal-header">
                                    <h3>سجل موردي المنتج: ${product.name}</h3>
                                    <button class="close-btn" id="close-product-history">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="product-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between; flex-wrap: wrap; gap: 15px;">
                                            <div><strong>الكمية المتوفرة:</strong> ${product.quantity}</div>
                                            <div><strong>السعر الحالي:</strong> ${(product.balance || 0).toFixed(2)} ج.م</div>
                                            <div><strong>عدد الموردين:</strong> ${suppliers.length}</div>
                                            <div><strong>إجمالي الكمية المشتراة:</strong> ${supplierHistory.reduce((sum, item) => sum + (parseInt(item.quantity) || 0), 0)}</div>
                                        </div>
                                    </div>
                                    
                                    <div class="suppliers-list">
                                        <h4 style="margin: 20px 0 15px; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                            سجل المشتريات من الموردين
                                        </h4>
                                        ${supplierHistory.length > 0 
                                            ? supplierHistory.map((item, index) => {
                                                console.log(`Processing history item ${index}:`, item);
                                                const supplier = this.getSupplier(item.supplierId);
                                                const supplierName = supplier ? supplier.name : 'مورد غير معروف';
                                                const date = item.date ? new Date(item.date) : new Date();
                                                const formattedDate = date.toLocaleDateString('ar-EG', {
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                });
                                                
                                                const quantity = parseInt(item.quantity) || 0;
                                                const price = parseFloat(item.price) || 0;
                                                const total = parseFloat(item.total) || 0;
                                                
                                                return `
                                                <div class="supplier-card" style="margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
                                                    <div class="supplier-header" style="background: #f8f9fa; padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                        <div style="display: flex; gap: 15px; align-items: center;">
                                                            <i class="fas fa-truck" style="color: #666;"></i>
                                                            <span style="font-weight: 500; color: #333;">${supplierName}</span>
                                                        </div>
                                                        <div style="color: #666; font-size: 0.9em;">
                                                            <i class="far fa-calendar-alt" style="margin-left: 5px;"></i>
                                                            ${formattedDate}
                                                        </div>
                                                    </div>
                                                    <div style="padding: 15px;">
                                                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 10px;">
                                                            <div>
                                                                <div style="color: #666; margin-bottom: 5px;">الكمية</div>
                                                                <div style="font-weight: 500;">${quantity}</div>
                                                            </div>
                                                            <div>
                                                                <div style="color: #666; margin-bottom: 5px;">سعر الوحدة</div>
                                                                <div style="font-weight: 500;">${price.toFixed(2)} ج.م</div>
                                                            </div>
                                                            <div>
                                                                <div style="color: #666; margin-bottom: 5px;">الإجمالي</div>
                                                                <div style="font-weight: bold; color: var(--secondary);">${total.toFixed(2)} ج.م</div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>`;
                                            }).join('')
                                            : `<div class="no-suppliers" style="text-align: center; padding: 30px; color: #666; background: #f9f9f9; border-radius: 8px; margin-top: 20px;">
                                                <i class="fas fa-truck-loading" style="font-size: 2em; margin-bottom: 15px; opacity: 0.5;"></i>
                                                <p style="margin: 0;">لا توجد سجلات مشتريات لهذا المنتج</p>
                                              </div>`}
                                    </div>
                                </div>
                                <div class="modal-footer" style="padding: 15px; border-top: 1px solid #eee; text-align: left;">
                                    <button class="btn btn-outline" id="close-product-history-btn" style="padding: 8px 20px;">
                                        <i class="fas fa-times"></i> إغلاق
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove any existing product history modal
                    const existingModal = document.getElementById('product-history-modal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    // Add modal to the page
                    document.body.insertAdjacentHTML('beforeend', modalHtml);

                    // Add event listeners for closing the modal
                    const closeModal = () => {
                        const modal = document.getElementById('product-history-modal');
                        if (modal) modal.remove();
                    };

                    // Close modal when clicking close button or overlay
                    document.getElementById('close-product-history')?.addEventListener('click', closeModal);
                    document.getElementById('close-product-history-btn')?.addEventListener('click', closeModal);
                    document.querySelector('#product-history-modal .modal-overlay')?.addEventListener('click', (e) => {
                        if (e.target === e.currentTarget) closeModal();
                    });

                    // Handle print button clicks
                    document.querySelectorAll('#product-history-modal .print-invoice-history-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            try {
                                const invoice = JSON.parse(btn.getAttribute('data-invoice').replace(/&#39;/g, "'"));
                                if (invoice) {
                                    console.log('Printing invoice from product history:', invoice);
                                    this.printInvoice(invoice);
                                } else {
                                    this.showAlert('تعذر العثور على بيانات الفاتورة', 'error');
                                }
                            } catch (error) {
                                console.error('Error parsing invoice data:', error);
                                this.showAlert('حدث خطأ أثناء معالجة بيانات الفاتورة', 'error');
                            }
                        });
                    });

                    // Close modal when pressing Escape key
                    document.addEventListener('keydown', function handleEscKey(e) {
                        if (e.key === 'Escape') {
                            closeModal();
                            document.removeEventListener('keydown', handleEscKey);
                        }
                    });

                } catch (error) {
                    console.error('Error showing product history:', error);
                    this.showAlert('حدث خطأ أثناء عرض سجل المنتج', 'error');
                }
            }

            
            showCustomerHistory(customerId) {
                try {
                    const customer = this.getCustomer(customerId);
                    if (!customer) {
                        this.showAlert('العميل غير موجود', 'error');
                        return;
                    }

                    // Calculate total purchases amount
                    const totalPurchases = customer.purchases?.reduce((sum, invoice) => {
                        return sum + (parseFloat(invoice.total) || 0);
                    }, 0) || 0;

                    // Create modal HTML
                    const modalHtml = `
                        <div class="modal-overlay active" id="customer-history-modal">
                            <div class="modal" style="max-width: 800px;">
                                <div class="modal-header">
                                    <h3>سجل معاملات العميل: ${customer.name}</h3>
                                    <button class="close-btn" id="close-customer-history">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div class="customer-info" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                                        <div style="display: flex; justify-content: space-between;">
                                            <div><strong>إجمالي المشتريات:</strong> ${customer.purchases?.length || 0}</div>
                                            <div><strong>الرصيد الحالي:</strong> ${(customer.balance || 0).toFixed(2)} ج.م</div>
                                        </div>
                                    </div>
                                    
                                    <div class="invoices-list">
                                        <h4 style="margin: 20px 0 15px; color: var(--primary); border-bottom: 2px solid var(--primary); padding-bottom: 8px;">
                                            الفواتير السابقة
                                        </h4>
                                        ${customer.purchases?.length > 0 
                                            ? customer.purchases.map((invoice, index) => {
                                                const invoiceDate = invoice.date ? new Date(invoice.date) : new Date();
                                                const formattedDate = invoiceDate.toLocaleDateString('ar-EG', {
                                                    year: 'numeric',
                                                    month: 'long',
                                                    day: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                });
                                                const total = parseFloat(invoice.total) || 0;
                                                const status = invoice.status === 'paid' ? 'مدفوعة' : 'غير مدفوعة';
                                                const statusClass = invoice.status === 'paid' ? 'status-success' : 'status-danger';
                                                const invoiceId = invoice.id || `inv-${Date.now()}-${index}`;
                                                const showInvoiceId = invoice.id && !invoiceId.startsWith('inv-');
                                                
                                                return `
                                                <div class="invoice-card" style="margin-bottom: 15px; border: 1px solid #eee; border-radius: 8px; overflow: hidden;">
                                                    <div class="invoice-header" style="background: #f8f9fa; padding: 12px 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                                                        <div style="display: flex; gap: 15px; align-items: center;">
                                                            ${showInvoiceId ? `<span class="invoice-id" style="font-weight: bold; color: var(--primary);">#${invoiceId}</span>` : ''}
                                                            <span class="invoice-date" style="color: #666;">${formattedDate}</span>
                                                        </div>
                                                        <div style="display: flex; align-items: center; gap: 15px;">
                                                            <span class="invoice-total" style="font-weight: bold; color: var(--secondary);">${total.toFixed(2)} ج.م</span>
                                                            <span class="status-badge ${statusClass}" style="padding: 4px 12px; border-radius: 15px; font-size: 0.85em;">
                                                                ${status}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div class="invoice-items" style="padding: 15px;">
                                                        <div style="margin-bottom: 10px; font-weight: 500; color: #555;">المنتجات:</div>
                                                        ${(invoice.items || []).map(item => {
                                                            const product = this.getProduct(item.id) || {};
                                                            const itemName = product.name || item.productName || 'منتج غير معروف';
                                                            const quantity = parseInt(item.quantity) || 0;
                                                            const price = parseFloat(item.balance || item.price || 0);
                                                            const subtotal = quantity * price;
                                                            
                                                            return `
                                                                <div class="invoice-item" style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                                                    <span>${itemName}</span>
                                                                    <div style="display: flex; gap: 20px;">
                                                                        <span>${quantity} × ${price.toFixed(2)} ج.م</span>
                                                                        <span style="font-weight: bold;">${subtotal.toFixed(2)} ج.م</span>
                                                                    </div>
                                                                </div>`;
                                                        }).join('')}
                                                    </div>
                                                    <div class="invoice-actions" style="padding: 10px 15px; background: #f9f9f9; text-align: left; border-top: 1px solid #eee;">
                                                        <button class="btn btn-sm btn-outline print-invoice-history-btn" 
                                                                data-invoice='${JSON.stringify(invoice).replace(/'/g, '&#39;')}'
                                                                style="padding: 5px 15px; font-size: 0.9em;">
                                                            <i class="fas fa-print"></i> طباعة الفاتورة
                                                        </button>
                                                    </div>
                                                </div>`;
                                            }).join('')
                                            : `<div class="no-invoices" style="text-align: center; padding: 30px; color: #666; background: #f9f9f9; border-radius: 8px; margin-top: 20px;">
                                                <i class="fas fa-receipt" style="font-size: 2em; margin-bottom: 15px; opacity: 0.5;"></i>
                                                <p style="margin: 0;">لا توجد فواتير سابقة لهذا العميل</p>
                                              </div>`}
                                    </div>
                                </div>
                                <div class="modal-footer" style="padding: 15px; border-top: 1px solid #eee; text-align: left;">
                                    <button class="btn btn-outline" id="close-customer-history-btn" style="padding: 8px 20px;">
                                        <i class="fas fa-times"></i> إغلاق
                                    </button>
                                </div>
                                </div>
                            </div>
                        </div>
                    `;

                    // Remove any existing customer history modal
                    const existingModal = document.getElementById('customer-history-modal');
                    if (existingModal) {
                        existingModal.remove();
                    }

                    // Add modal to the page
                    document.body.insertAdjacentHTML('beforeend', modalHtml);

                    // Add event listeners for closing the modal
                    const closeModal = () => {
                        const modal = document.getElementById('customer-history-modal');
                        if (modal) modal.remove();
                    };

                    // Close modal when clicking close button or overlay
                    document.getElementById('close-customer-history')?.addEventListener('click', closeModal);
                    document.getElementById('close-customer-history-btn')?.addEventListener('click', closeModal);
                    document.querySelector('#customer-history-modal .modal-overlay')?.addEventListener('click', (e) => {
                        if (e.target === e.currentTarget) closeModal();
                    });

                    // Handle print button clicks
                    document.querySelectorAll('#customer-history-modal .print-invoice-history-btn').forEach(btn => {
                        btn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            try {
                                const invoice = JSON.parse(btn.getAttribute('data-invoice').replace(/&#39;/g, "'"));
                                if (invoice) {
                                    console.log('Printing invoice from history:', invoice);
                                    // Ensure we have the customer data
                                    const customer = this.getCustomer(invoice.customerId) || { name: 'عميل نقدي' };
                                    const invoiceWithCustomer = {
                                        ...invoice,
                                        customer: customer,
                                        customerName: customer.name
                                    };
                                    this.printInvoice(invoiceWithCustomer);
                                } else {
                                    this.showAlert('تعذر العثور على بيانات الفاتورة', 'error');
                                }
                            } catch (error) {
                                console.error('Error parsing invoice data:', error);
                                this.showAlert('حدث خطأ أثناء معالجة بيانات الفاتورة', 'error');
                            }
                        });
                    });

                    // Close modal when pressing Escape key
                    document.addEventListener('keydown', function handleEscKey(e) {
                        if (e.key === 'Escape') {
                            closeModal();
                            document.removeEventListener('keydown', handleEscKey);
                        }
                    });

                } catch (error) {
                    console.error('Error showing customer history:', error);
                    this.showAlert('حدث خطأ أثناء عرض سجل العميل', 'error');
                }
            }

            renderCustomersTable() {
                const tbody = document.getElementById('customers-table-body');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                const start = (this.currentPage.customers - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                const paginatedCustomers = this.customers.slice(start, end);
                
                if (paginatedCustomers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-users"></i>
                                    <h3>لا يوجد عملاء</h3>
                                    <p>قم بإضافة عملاء جدد لعرضهم هنا</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }
                
                paginatedCustomers.forEach((customer, index) => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.title = 'انقر لعرض سجل المعاملات';
                    row.innerHTML = `
                        <td>${start + index + 1}</td>
                        <td>${customer.name}</td>
                        <td>${customer.phone}</td>
                        <td>${customer.balance?.toFixed(2) || '0.00'} ج.م</td>
                        <td class="actions">
                            <button class="action-btn edit" data-id="${customer.id}" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" data-id="${customer.id}" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="action-btn history" data-id="${customer.id}" title="سجل المعاملات">
                                <i class="fas fa-history"></i>
                            </button>
                        </td>`;
                    tbody.appendChild(row);

                    // Add click handler to the row
                    row.addEventListener('click', (e) => {
                        // Don't trigger if clicking on action buttons
                        if (!e.target.closest('.action-btn')) {
                            this.showCustomerHistory(customer.id);
                        }
                    });
                });
                
                // Add event listeners to action buttons
                tbody.querySelectorAll('.edit').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.openCustomerModal(id);
                    });
                });
                
                tbody.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showDeleteConfirmation(id, 'customer', 'هل أنت متأكد أنك تريد حذف هذا العميل؟');
                    });
                });
                
                tbody.querySelectorAll('.history').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showCustomerHistory(id);
                    });
                });
                
                // Render pagination
                this.renderPagination('customers', this.customers.length);
            }
            
            renderSuppliersTable(filteredSuppliers = null) {
                console.log('renderSuppliersTable called with filteredSuppliers:', filteredSuppliers);
                const tbody = document.getElementById('suppliers-table-body');
                if (!tbody) {
                    console.error('Suppliers table body not found!');
                    return;
                }
                
                tbody.innerHTML = '';
                
                const suppliersToDisplay = filteredSuppliers || this.suppliers;
                console.log('Suppliers to display:', suppliersToDisplay);
                
                if (!suppliersToDisplay || !Array.isArray(suppliersToDisplay)) {
                    console.error('Invalid suppliers data:', suppliersToDisplay);
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <h3>خطأ في تحميل بيانات الموردين</h3>
                                    <p>الرجاء تحديث الصفحة وحاول مرة أخرى</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }
                
                const start = (this.currentPage.suppliers - 1) * this.itemsPerPage;
                const end = start + this.itemsPerPage;
                const paginatedSuppliers = suppliersToDisplay.slice(start, end);
                
                console.log('Paginated suppliers:', paginatedSuppliers);
                
                if (paginatedSuppliers.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="4" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-truck"></i>
                                    <h3>${filteredSuppliers ? 'لا توجد نتائج' : 'لا يوجد موردين'}</h3>
                                    <p>${filteredSuppliers ? 'لم يتم العثور على موردين بهذه المواصفات' : 'قم بإضافة موردين جدد لعرضهم هنا'}</p>
                                </div>
                            </td>
                        </tr>`;
                    return;
                }
                
                paginatedSuppliers.forEach((supplier, index) => {
                    const row = document.createElement('tr');
                    row.style.cursor = 'pointer';
                    row.title = 'انقر لعرض سجل المعاملات';
                    row.innerHTML = `
                        <td>${start + index + 1}</td>
                        <td>${supplier.name}</td>
                        <td>${supplier.phone}</td>
                        <td class="actions">
                            <button class="action-btn edit" data-id="${supplier.id}" title="تعديل">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" data-id="${supplier.id}" title="حذف">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="action-btn history" data-id="${supplier.id}" title="سجل المعاملات">
                                <i class="fas fa-history"></i>
                            </button>
                        </td>`;
                    tbody.appendChild(row);
                });
                
                // Add event listeners to action buttons
                tbody.querySelectorAll('.edit').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const id = e.currentTarget.getAttribute('data-id');
                        this.openSupplierModal(id);
                    });
                });
                
                tbody.querySelectorAll('.delete').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showDeleteConfirmation(id, 'supplier', 'هل أنت متأكد أنك تريد حذف هذا المورد؟');
                    });
                });
                
                tbody.querySelectorAll('.history').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const id = e.currentTarget.getAttribute('data-id');
                        this.showSupplierHistory(id);
                    });
                });
                
                // Add search functionality
                const searchInput = document.getElementById('supplier-search');
                if (searchInput) {
                    searchInput.addEventListener('input', (e) => {
                        const searchTerm = e.target.value.toLowerCase();
                        const filtered = this.suppliers.filter(supplier => 
                            supplier.name.toLowerCase().includes(searchTerm) ||
                            supplier.phone.includes(searchTerm)
                        );
                        this.renderSuppliersTable(filtered);
                    });
                }
                
                // Render pagination if not filtered
                if (!filteredSuppliers) {
                    this.renderPagination('suppliers', this.suppliers.length);
                }
            }
            
            renderPagination(type, totalItems) {
                const pagination = this.pagination[type];
                if (!pagination) return;
                
                const totalPages = Math.ceil(totalItems / this.itemsPerPage);
                
                pagination.innerHTML = '';
                
                if (totalPages <= 1) {
                    pagination.style.display = 'none';
                    return;
                }
                
                pagination.style.display = 'flex';
                
                // Ensure current page is within bounds
                if (this.currentPage[type] > totalPages) {
                    this.currentPage[type] = totalPages;
                }
                
                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn';
                prevBtn.disabled = this.currentPage[type] === 1;
                prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                prevBtn.addEventListener('click', () => {
                    if (this.currentPage[type] > 1) {
                        this.currentPage[type]--;
                        this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                        window.scrollTo(0, 0);
                    }
                });
                
                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn';
                nextBtn.disabled = this.currentPage[type] === totalPages;
                nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                nextBtn.addEventListener('click', () => {
                    if (this.currentPage[type] < totalPages) {
                        this.currentPage[type]++;
                        this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                        window.scrollTo(0, 0);
                    }
                });
                
                // Page buttons
                const pageButtons = [];
                const maxPagesToShow = 5;
                let startPage, endPage;
                
                if (totalPages <= maxPagesToShow) {
                    startPage = 1;
                    endPage = totalPages;
                } else {
                    if (this.currentPage[type] <= Math.ceil(maxPagesToShow / 2)) {
                        startPage = 1;
                        endPage = maxPagesToShow;
                    } else if (this.currentPage[type] + Math.floor(maxPagesToShow / 2) >= totalPages) {
                        startPage = totalPages - maxPagesToShow + 1;
                        endPage = totalPages;
                    } else {
                        startPage = this.currentPage[type] - Math.floor(maxPagesToShow / 2);
                        endPage = this.currentPage[type] + Math.floor(maxPagesToShow / 2);
                    }
                }
                
                // Add page buttons
                for (let i = startPage; i <= endPage; i++) {
                    const pageBtn = document.createElement('button');
                    pageBtn.className = `pagination-btn ${i === this.currentPage[type] ? 'active' : ''}`;
                    pageBtn.textContent = i;
                    pageBtn.addEventListener('click', () => {
                        if (i !== this.currentPage[type]) {
                            this.currentPage[type] = i;
                            this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                            window.scrollTo(0, 0);
                        }
                    });
                    pageButtons.push(pageBtn);
                }
                
                // Build pagination
                pagination.appendChild(prevBtn);
                
                // First page and ellipsis
                if (startPage > 1) {
                    const firstPageBtn = document.createElement('button');
                    firstPageBtn.className = 'pagination-btn';
                    firstPageBtn.textContent = '1';
                    firstPageBtn.addEventListener('click', () => {
                        this.currentPage[type] = 1;
                        this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                        window.scrollTo(0, 0);
                    });
                    pagination.appendChild(firstPageBtn);
                    
                    if (startPage > 2) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'pagination-ellipsis';
                        ellipsis.textContent = '...';
                        pagination.appendChild(ellipsis);
                    }
                }
                
                // Page buttons
                pageButtons.forEach(btn => pagination.appendChild(btn));
                
                // Last page and ellipsis
                if (endPage < totalPages) {
                    if (endPage < totalPages - 1) {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'pagination-ellipsis';
                        ellipsis.textContent = '...';
                        pagination.appendChild(ellipsis);
                    }
                    
                    const lastPageBtn = document.createElement('button');
                    lastPageBtn.className = 'pagination-btn';
                    lastPageBtn.textContent = totalPages;
                    lastPageBtn.addEventListener('click', () => {
                        this.currentPage[type] = totalPages;
                        this[`render${type.charAt(0).toUpperCase() + type.slice(1)}Table`]();
                        window.scrollTo(0, 0);
                    });
                    pagination.appendChild(lastPageBtn);
                }
                
                pagination.appendChild(nextBtn);
            }
            
            updateDashboard() {
                // Total products
                this.dashboardElements.totalProducts.textContent = this.products.length;
                
                // Monthly invoices (last 30 days)
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
                
                const monthlyInvoices = this.invoices.filter(invoice => {
                    const invoiceDate = new Date(invoice.date);
                    return invoiceDate >= thirtyDaysAgo;
                });
                
                this.dashboardElements.monthlyInvoices.textContent = monthlyInvoices.length;
                
                // Low stock products (quantity <= 10)
                const lowStockProducts = this.products.filter(p => p.quantity > 0 && p.quantity <= 10);
                this.dashboardElements.lowStockCount.textContent = lowStockProducts.length;
                
                // Inventory value
                const inventoryValue = this.products.reduce((sum, p) => sum + (p.balance * p.quantity), 0);
                this.dashboardElements.inventoryValue.textContent = inventoryValue.toLocaleString('ar-EG') + ' ج.م';
                
                // Latest products (5 most recently added)
                const latestProducts = [...this.products]
                    .sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0))
                    .slice(0, 5);
                
                this.tables.latestProducts.innerHTML = '';
                latestProducts.forEach(product => {
                    const row = document.createElement('tr');
                    
                    // Determine product status
                    let statusClass, statusText;
                    if (product.quantity === 0) {
                        statusClass = 'status-danger';
                        statusText = 'منتهي';
                    } else if (product.quantity <= 10) {
                        statusClass = 'status-warning';
                        statusText = 'كمية منخفضة';
                    } else {
                        statusClass = 'status-success';
                        statusText = 'متوفر';
                    }
                    
                    row.innerHTML = `
                        <td>${product.name}</td>
                        <td>${product.balance.toFixed(2)}</td>
                        <td class="${product.quantity === 0 ? 'no-stock' : (product.quantity <= 10 ? 'low-stock' : '')}">
                            ${product.quantity}
                        </td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td class="actions">
                            <button class="action-btn edit" data-id="${product.id}" title="تعديل المنتج">
                                <i class="fas fa-edit"></i>
                            </button>
                        </td>
                    `;
                    
                    this.tables.latestProducts.appendChild(row);
                    
                    // Add edit event listener
                    row.querySelector('.action-btn.edit').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.openProductModal(product.id);
                    });
                });
                
                // Recent invoices (5 most recent)
                const recentInvoices = [...this.invoices]
                    .sort((a, b) => new Date(b.date) - new Date(a.date))
                    .slice(0, 5);
                
                this.tables.recentInvoices.innerHTML = '';
                recentInvoices.forEach((invoice, index) => {
                    const row = document.createElement('tr');
                    const rowNumber = index + 1; // 1-based index
                    
                    // Format status
                    let statusClass = '';
                    let statusText = '';
                    
                    switch(invoice.status) {
                        case 'sales':
                            statusClass = 'status-info';
                            statusText = 'فاتورة مبيعات';
                            break;
                        case 'paid':
                            statusClass = 'status-success';
                            statusText = 'مدفوعة';
                            break;
                        case 'unpaid':
                            statusClass = 'status-danger';
                            statusText = 'غير مدفوعة';
                            break;
                        case 'partial':
                            statusClass = 'status-warning';
                            statusText = 'مدفوعة جزئياً';
                            break;
                        case 'pending':
                            statusClass = 'status-warning';
                            statusText = 'قيد المراجعة';
                            break;
                        default:
                            statusClass = 'status-secondary';
                            statusText = 'غير معروفة';
                    }
                    
                    // Get customer name, fallback to invoice.customer or 'عميل نقدي'
                    const customer = this.getCustomer(invoice.customerId) || { name: invoice.customer || 'عميل نقدي' };
                    
                    row.innerHTML = `
                        <td>${rowNumber}</td>
                        <td>${customer.name}</td>
                        <td>${invoice.date}</td>
                        <td>${invoice.total.toFixed(2)} ج.م</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn print-invoice-btn" data-id="${invoice.id}" title="طباعة">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                    
                    this.tables.recentInvoices.appendChild(row);
                    
                    // Add print event listener to the button
                    row.querySelector('.print-invoice-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        this.printInvoice(invoice.id);
                    });
                });
            }
            
            showAlert(message, type) {
                // Remove any existing alerts
                const existingAlert = document.querySelector('.alert');
                if (existingAlert) existingAlert.remove();
                
                // Create alert element
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert alert-${type}`;
                alertDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
                        <span>${message}</span>
                    </div>
                    <button class="close-alert">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                // Add alert to content area
                const contentArea = document.querySelector('.content-area');
                if (contentArea) {
                    contentArea.insertBefore(alertDiv, contentArea.firstChild);
                }
                
                // Add close event
                alertDiv.querySelector('.close-alert').addEventListener('click', () => {
                    alertDiv.remove();
                });
                
                // Auto-remove after 5 seconds
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }
        }

        // Initialize the application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            window.inventorySystem = new InventorySystem();
            
            // Initialize reports page if it's the active page on load
            const reportsPage = document.getElementById('reports-page');
            if (reportsPage && window.getComputedStyle(reportsPage).display !== 'none') {
                console.log('Reports page is active, initializing...');
                window.updateReportsPage();
            }
        });
    </script>
    
    <!-- Load sample data -->
    <script src="assets.js"></script>
    
    <!-- Main application script -->
    <script>
        // Set up event listeners when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM fully loaded, initializing application...');
            
            // Set up click handler for all menu items
            document.querySelectorAll('.menu-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const pageId = e.currentTarget.getAttribute('data-page');
                    console.log('Menu item clicked:', pageId);
                    
                    // Hide all pages
                    document.querySelectorAll('[id$="-page"]').forEach(page => {
                        page.style.display = 'none';
                    });
                    
                    // Show selected page
                    const selectedPage = document.getElementById(pageId);
                    if (selectedPage) {
                        selectedPage.style.display = 'block';
                    }
                    
                    // Update active menu item
                    document.querySelectorAll('.menu-item').forEach(menuItem => {
                        menuItem.classList.remove('active');
                    });
                    e.currentTarget.classList.add('active');
                });
            });
            
            // Show the dashboard by default
            const defaultPage = document.getElementById('dashboard-page');
            if (defaultPage) {
                defaultPage.style.display = 'block';
                document.querySelector('.menu-item[data-page="dashboard-page"]')?.classList.add('active');
            }
        });
    </script>
</body>
</html>